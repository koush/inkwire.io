function nextTick(e){setTimeout(e,0)}function make4Len16(e){var t=e.toString(16);while(t.length<4){t="0"+t}return t}function encode_utf8(e){return unescape(encodeURIComponent(e))}function decode_utf8(e){return decodeURIComponent(escape(e))}function ab2str(e){if(e.constructor.name=="ArrayBuffer"){e=new Uint8Array(e)}return decode_utf8(String.fromCharCode.apply(null,e))}function str2ab(e,t,n){e=encode_utf8(e);var i=e.length;if(n)i++;if(!t){t=new ArrayBuffer(i)}var o=new Uint8Array(t);if(n)o[e.length]=0;for(var r=0,s=e.length;r<s;r++){o[r]=e.charCodeAt(r)}return t}var slashN="\n".charCodeAt(0);function writeLine(e,t,n){if(t.constructor.name=="Object")t=JSON.stringify(t);writeString(e,t+"\n",n)}function readLine(e,t){var n=[];function i(){e.read(function(o){for(var r=0;r<o.byteLength;r++){if(o[r]==slashN){var s=o.subarray(0,r);n.push(s);var a="";for(var c in n){c=n[c];a+=ab2str(c)}var u=o.subarray(r+1);e.unshift(u);t(a);return}}n.push(o);i()})}i()}function readString(e,t){var n="";e.onClose=function(){t(n)};function i(t){n+=ab2str(t);e.read(i)}e.read(i)}function writeString(e,t,n){if(t.constructor.name=="Object")t=JSON.stringify(t);e.write(str2ab(t),n)}function appendBuffer(e,t){var n=new Uint8Array(e.byteLength+t.byteLength);n.set(e,0);n.set(t,e.byteLength);return n}var timeThing=(new Date).getTime();function timeTrace(e){var t=(new Date).getTime();console.log(e+": "+(t-timeThing));timeThing=t}function bufferToHex(e){var t=new Uint8Array(e);var n="";for(var i in t){i=t[i];if(i<16)n+="0"+i.toString(16);else n+=i.toString(16)}return n}function hexToBuffer(e){var t=new ArrayBuffer(e.length/2);var n=new Uint8Array(t);for(var i=0;i<e.length/2;i++){var o=e.substr(i*2,2);n[i]=parseInt(o,16)}return t}function base64ToArrayBuffer(e){var t=window.atob(e);var n=t.length;var i=new Uint8Array(n);for(var o=0;o<n;o++){var r=t.charCodeAt(o);i[o]=r}return i.buffer}function arrayBufferToBase64(e){var t="";var n=new Uint8Array(e);var i=n.byteLength;for(var o=0;o<i;o++){t+=String.fromCharCode(n[o])}return window.btoa(t)}var b64map="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";var b64pad="=";function hex2b64(e){var t;var n;var i="";for(t=0;t+3<=e.length;t+=3){n=parseInt(e.substring(t,t+3),16);i+=b64map.charAt(n>>6)+b64map.charAt(n&63)}if(t+1==e.length){n=parseInt(e.substring(t,t+1),16);i+=b64map.charAt(n<<2)}else if(t+2==e.length){n=parseInt(e.substring(t,t+2),16);i+=b64map.charAt(n>>2)+b64map.charAt((n&3)<<4)}while((i.length&3)>0){i+=b64pad}return i}if(!String.prototype.startsWith){Object.defineProperty(String.prototype,"startsWith",{enumerable:false,configurable:false,writable:false,value:function(e,t){t=t||0;return this.lastIndexOf(e,t)===t}})}function getQueryVariable(e,t){if(!t)t=window.location;var n=t.search.substring(1);var i=n.split("&");for(var o=0;o<i.length;o++){var r=i[o].split("=");if(decodeURIComponent(r[0])==e){return decodeURIComponent(r[1])}}}Object.fromArray=function(e){var t={};for(var n in e){var i=e[n];t[i]=i}return t};$.ajaxTransport("+binary",function(e,t,n){if(window.FormData&&(e.dataType&&e.dataType=="binary"||e.data&&(window.ArrayBuffer&&e.data instanceof ArrayBuffer||window.Blob&&e.data instanceof Blob))){return{send:function(t,n){var i=new XMLHttpRequest,o=e.url,r=e.type,s=e.async||true,a=e.responseType||"blob",c=e.data||null,u=e.username||null,d=e.password||null;i.addEventListener("load",function(){var t={};t[e.dataType]=i.response;n(i.status,i.statusText,t,i.getAllResponseHeaders())});i.open(r,o,s,u,d);for(var l in t){i.setRequestHeader(l,t[l])}i.responseType=a;i.send(c)},abort:function(){n.abort()}}}});function throttleTimeout(e,t,n,i){if(!e)e={items:[]};e.items.push(t);if(!e.timeout){e.timeout=setTimeout(function(){delete e.timeout;i(e.items);e.items=[]},n)}return e}function copyTextToClipboard(e){var t=document.createElement("textarea");t.style.position="fixed";t.style.top=0;t.style.left=0;t.style.width="2em";t.style.height="2em";t.style.padding=0;t.style.border="none";t.style.outline="none";t.style.boxShadow="none";t.style.background="transparent";t.value=e;document.body.appendChild(t);t.select();try{var n=document.execCommand("copy")}catch(i){console.log("Oops, unable to copy")}document.body.removeChild(t)}function showNotification(e,t){console.log("notification:",e);if(!window.chrome||!window.chrome.notifications)return;var n=chrome.runtime.getManifest();var i=n.name;t=t||n.icons[128];chrome.notifications.create({type:"basic",iconUrl:t,title:i,message:e})}var blobFromUrl=function(){var e={};return function(t,n){if(e[t]){n(e[t]);return}var i=new XMLHttpRequest;i.open("GET",t,true);i.responseType="blob";i.onload=function(i){n(e[t]=window.URL.createObjectURL(this.response))};i.send()}}();function Success(){}(function(){function*e(){}var t=e();t.constructor.prototype.async=function(){var e=this;var t=e.next();if(t.done)return;function n(){t=e.throw(new Error(arguments));o()}function i(){var n=arguments[0];t=e.next(n);o()}function o(o){var r;var s;if(t.done)return;if(!t.value){t=e.next(i);return}if(t.value.constructor==Promise){t.value.then(i).catch(n);return}if(t.value==Error){r=true;t=e.next(n)}else if(t.value==Success){s=true;t=e.next(i)}else{throw new Error("Unexpected yield value for callback. Only Error and Success allowed.")}if(!t.value)throw new Error("Double yield callbacks must explicitly define both Error and Success");if(t.value==Error&&r)throw new Error("Error callback already defined");else if(t.value==Success&&s)throw new Error("Success callback already defined");else if(t.value!=Error&&t.value!=Success)throw new Error("Unexpected yield value for callback. Only Error and Success allowed.");if(r)t=e.next(i);else t=e.next(n)}o()}})();function spewSocket(e){e.read(function(t){console.log(ab2str(t));spewSocket(e)})}function getAuthToken(e,t){if(!window.chrome||!window.chrome.identity){console.error("no auth token implemented");process.nextTick(t);return}chrome.identity.getAuthToken({interactive:e,scopes:["https://www.googleapis.com/auth/userinfo.profile","https://www.googleapis.com/auth/userinfo.email","https://www.googleapis.com/auth/chromewebstore.readonly"]},function(e){if(!e)console.error("unable to get authToken",chrome.runtime.lastError);t(e)})}window.isElectron=function(){return navigator.userAgent.indexOf("Electron")!=-1};if(!isElectron()){window.sharedGlobals=window}(function(){var e=console.log;var t=console.error;var n="";function i(e){try{for(var t in e){if(e[t]&&e[t].constructor!=String)e[t]=JSON.stringify(e[t])}n+=e.join(" ")+"\n"}catch(i){}}console.error=function(){t.apply(console,arguments);i(Array.prototype.slice.call(arguments))};console.log=function(){e.apply(console,arguments);i(Array.prototype.slice.call(arguments))};sharedGlobals.getConsoleLog=function(e){e(n)};function o(e){return new Promise(function(t,n){if(!e.getConsoleLog){t("getConsoleLog not found");return}e.getConsoleLog(function(e){t({content:e})})})}window.gistConsoleLog=function(e,t){chrome.runtime.getBackgroundPage(function(n){o(n).then(function(t){e["background.txt"]=t;var n=chrome.app.window.getAll();var i=n.map(function(t){return o(t.contentWindow).then(function(n){e["window-"+t.id+".txt"]=n})});return Promise.all(i)}).then(function(){var n={description:chrome.runtime.getManifest().name+" console log","public":false,files:e};fetch("https://api.github.com/gists",{method:"POST",body:JSON.stringify(n)}).then(function(e){e.json().then(function(e){t(e.html_url)})})})})}})();(function(){function e(e){this.buffer=new ArrayBuffer(e);this.dataView=new DataView(this.buffer);this.uint8array=new Uint8Array(this.buffer);this.littleEndian=false;this.position=0;this.limit=e;this.capacity=e}e.prototype.flip=function(){this.limit=this.position;this.position=0};e.prototype.asUint8Array=function(){return this.uint8array.subarray(this.position,this.limit)};function t(t,n){var i=n*8;var o=t+i;var r="get"+o;var s="set"+o;var a="put"+o;e.prototype[r]=function(){if(this.position+n>this.limit)throw new Error("Not enough room in byte buffer");var e=this.dataView[r](this.position,this.littleEndian);this.position+=n;return e};e.prototype[a]=function(e){if(this.position+n>this.limit)throw new Error("Not enough room in byte buffer");if(e==null||e==undefined||e==NaN||e.constructor!=Number)throw new Error("no value provided");this.dataView[s](this.position,e,this.littleEndian);this.position+=n;return this}}var n={Int:[1,2,4],Uint:[1,2,4],Float:[4,8]};for(var i in n){var o=n[i];for(var r in o){var r=o[r];t(i,r)}}e.prototype.put=function(e){if(e.constructor==Number)return this.putInt8(e);if(e.constructor==String)e=str2ab(e);if(e.constructor==ArrayBuffer)e=new Uint8Array(e);if(this.position+e.byteLength>this.limit)throw new Error("Not enough room in byte buffer");this.uint8array.set(e,this.position);this.position+=e.byteLength;return this};e.prototype.putByte=e.prototype.putInt8;e.prototype.putShort=e.prototype.putInt16;e.prototype.putInt=e.prototype.putInt32;e.prototype.putFloat=e.prototype.putFloat32;e.prototype.putDouble=e.prototype.putFloat64;window.ByteBuffer=e})();if(window.chrome&&window.chrome.sockets){chrome.sockets.tcp.onReceive.addListener(function(e){var t=Socket.readers[e.socketId];if(t==null)return;t.dataReceived(new Uint8Array(e.data))});chrome.sockets.tcp.onReceiveError.addListener(function(e){var t=Socket.readers[e.socketId];if(t==null)return;t.destroy();t.dataReceived(null)});chrome.sockets.tcpServer.onAccept.addListener(function(e){chrome.sockets.tcp.setPaused(e.clientSocketId,false);var t=Server.listeners[e.socketId];if(t==null)return;t(new Socket({socketId:e.clientSocketId}))})}(function(){function e(t,n){if(t.socketId){this.socketId=t.socketId;e.readers[this.socketId]=this}else if(window.chrome&&window.chrome.sockets){chrome.sockets.tcp.create(function(i){this.socketId=i.socketId;chrome.sockets.tcp.connect(this.socketId,t.host,t.port,function(t){if(!t){e.readers[i.socketId]=this;n(this)}else{chrome.runtime.lastError;this.destroy();n(null)}}.bind(this))}.bind(this))}else{var i;if(!t.ns){this.ns=new require("net").Socket();this.ns.connect({port:t.port,host:t.host},function(){i=true;n(this)}.bind(this))}else{this.ns=t.ns;i=true}this.ns.on("close",function(){this.destroy();if(!i)n(null)}.bind(this));this.ns.on("data",function(e){this.dataReceived(e)}.bind(this))}}e.readers={};e.connect=function(t,n){return new e(t,n)};e.pump=function(e,t,n){if(!e||!t){console.error("Socket.pump called with null socket",e,t);n();return}var i=function(){e.read(o)}.bind(e);var o=function(e){var n=e.buffer;if(e.byteOffset||e.length!=n.byteLength){n=n.slice(e.byteOffset,e.byteOffset+e.length)}t.write(n,i)}.bind(t);e.read(o);e.onClose=n};e.stream=function(t,n,i){e.pump(t,n,function(){if(n)n.destroy();if(i){var e=i;i=null;e()}});e.pump(n,t,function(){if(t)t.destroy();if(i){var e=i;i=null;e()}})};e.eat=function(e){function t(){e.read(t)}t()};e.prototype.read=function(){if(this.pendingCallback){throw new Error("double callback")}if(this.closed&&!this.pending){var e=this.onClose;if(e){delete this.onClose;e()}return}var t=0;if(arguments[t].constructor.name=="Number"){this.pendingLength=arguments[t++]}else{this.pendingLength=0}var e=arguments[t];if(!this.pending||this.paused){this.pendingCallback=e;return}if(!this.pendingLength){this.pendingLength=this.buffered()}else if(this.pendingLength>this.buffered()){this.pendingCallback=e;return}var n;var i=0;while(i<this.pendingLength){var o=this.pending.shift();this.bufferedLength-=o.length;if(!this.pending.length)delete this.pending;var r=o;var s=Math.min(r.byteLength,this.pendingLength-i);if(s!=r.byteLength){var a=r.subarray(0,s);var c=r.subarray(s);this.unshift(c);r=a}if(!n&&r.byteLength!=this.pendingLength)n=new Uint8Array(this.pendingLength);if(n){n.set(r,i)}else{n=r}i+=r.byteLength}e(n)};e.prototype.write=function(e,t){if(this.pendingWrite)console.error("write is already in progress!");if(t==null){console.error("write callback is null?");t=function(){}}this.pendingWrite=t;if(window.chrome&&window.chrome.sockets){chrome.sockets.tcp.send(this.socketId,e,function(n){chrome.runtime.lastError;if(!n||n.resultCode){delete this.pendingWrite;return}if(n.bytesSent<e.byteLength){this.write(e.slice(n.bytesSent),t)}else{delete this.pendingWrite;t()}}.bind(this))}else{if(!this.ns)return;if(!e.byteLength){require("process").nextTick(function(){delete this.pendingWrite;t()}.bind(this));return}this.ns.write(Buffer.from(e),function(){delete this.pendingWrite;t()}.bind(this))}};e.prototype.destroy=function(e,t){if(window.chrome&&window.chrome.sockets){chrome.sockets.tcp.close(this.socketId,function(){chrome.runtime.lastError})}else{this.dataReceived(null);if(this.ns){this.ns.destroy();delete this.ns}}};e.prototype.unshift=function(e){if(e.byteLength==0)return;if(!this.pending)this.pending=[e];else this.pending.unshift(e);if(!this.bufferedLength)this.bufferedLength=0;this.bufferedLength+=e.length};e.prototype.dataReceived=function(e){if(e){if(e.asUint8Array)e=e.asUint8Array();if(e.constructor==ArrayBuffer)e=new Uint8Array(e)}if(e&&e.length){var t=new Uint8Array(e);if(!this.pending)this.pending=[t];else this.pending.push(t)}if(e==null){this.closed=true}else{if(!this.bufferedLength)this.bufferedLength=0;this.bufferedLength+=e.length}if(this.paused||!this.pending||!this.pending.length){var n=this.onClose;if(this.closed&&n){delete this.onClose;n()}return}var i=this.pendingLength;var n=this.pendingCallback;if(n){delete this.pendingCallback;this.read(i,n)}};e.prototype.buffered=function(){return this.bufferedLength};e.prototype.pause=function(){if(this.paused){return}this.paused=true;this.onPause()};e.prototype.resume=function(){if(!this.paused){return}this.paused=false;this.onResume()};e.prototype.onResume=function(){chrome.sockets.tcp.setPaused(this.socketId,false,function(){})};e.prototype.onPause=function(){chrome.sockets.tcp.setPaused(this.socketId,true,function(){})};function t(){}t.listeners={};t.prototype.__proto__=e.prototype;t.prototype.destroy=function(){if(window.chrome&&window.chrome.sockets){chrome.sockets.tcpServer.close(this.socketId,function(){chrome.runtime.lastError})}else{if(this.ns){this.ns.close();delete this.ns}}};t.prototype.listen=function(n,i,o){var r;var s;if(n.constructor.name=="Number"){r=n;s="0.0.0.0"}else{s=n.address;r=n.port}if(window.chrome&&window.chrome.sockets){chrome.sockets.tcpServer.create(function(e){this.socketId=e.socketId;t.listeners[this.socketId]=i;chrome.sockets.tcpServer.listen(e.socketId,s,r,function(e){chrome.runtime.lastError;if(e){this.destroy();if(o){o(e)}return}chrome.sockets.tcpServer.getInfo(this.socketId,function(t){this.localAddress=t.localAddress;this.localPort=t.localPort;if(o){o(e)}}.bind(this))}.bind(this))}.bind(this))}else{this.ns=require("net").createServer(function(t){i(new e({ns:t}))}.bind(this));this.ns.on("close",function(){this.destroy()}.bind(this));this.ns.on("error",function(e){if(o)o(e)}.bind(this));this.ns.on("listening",function(){var e=this.ns.address();this.localAddress=e.address;this.localPort=e.port;if(o)o()}.bind(this));this.ns.listen({port:r,host:s})}};window.Socket=e;window.Server=t})();function FetchSocket(e,t){this.promise=fetch(e).then(function(e){this.connected=true;this.response=e;this.reader=this.response.body.getReader();this.reader.closed.then(function(){if(this.onClose)this.dataReceived(null)}.bind(this));this.onResume();t(this)}.bind(this),function(e){t(null,e)})}FetchSocket.connect=function(e,t){new FetchSocket(e,t)};FetchSocket.prototype.write=function(e,t){throw new Error("write not supported on fetch socket")};FetchSocket.prototype.destroy=function(){if(this.promise&&this.promise.cancel)this.promise.cancel()};FetchSocket.prototype.unshift=Socket.prototype.unshift;FetchSocket.prototype.dataReceived=Socket.prototype.dataReceived;FetchSocket.prototype.read=Socket.prototype.read;FetchSocket.prototype.pause=Socket.prototype.pause;FetchSocket.prototype.resume=Socket.prototype.resume;FetchSocket.prototype.buffered=Socket.prototype.buffered;FetchSocket.prototype.onPause=function(){};FetchSocket.prototype.onResume=function(){this.reader.read().then(function(e){if(!e.value)return;this.dataReceived(e.value);if(this.paused){return}this.onResume()}.bind(this))};(function(){function e(e,t){this.conn=e;this.dc=t;this.gotEof=false;t.onmessage=function(e){var t=new Uint8Array(e.data);var n=t[t.byteLength-1]==1;this.dataReceived(t.subarray(0,t.byteLength-1));if(n){this.gotEof=true;this.destroy()}}.bind(this);t.onclose=t.onerror=this.destroy.bind(this);this.needsBufferShim=true||parseInt(/Chrome\/(\d\d)/.exec(navigator.userAgent)[1])<46}e.prototype.buffered=Socket.prototype.buffered;e.prototype.unshift=Socket.prototype.unshift;e.prototype.dataReceived=Socket.prototype.dataReceived;e.prototype.read=Socket.prototype.read;e.prototype.pause=Socket.prototype.pause;e.prototype.resume=Socket.prototype.resume;e.prototype.buffered=Socket.prototype.buffered;e.prototype.writeable=function(){var e=this.writeCallback;if(e){delete this.writeCallback;e()}};e.prototype.write=function(e,t){if(!this.dc||this.dc.readyState!="open"){this.destroy();return}this.writeCallback=t;var n=new Uint8Array(e.byteLength+1);n.set(new Uint8Array(e));this.dc.send(n.buffer);if(this.reentrantWrite)return;try{this.reentrantWrite=true;while(this.writeCallback&&(this.dc.bufferedAmount==0||this.needsBufferShim)){this.writeable()}}finally{this.reentrantWrite=false}};e.prototype.destroy=function(){this.dataReceived(null);if(this.dc==null)return;var e=this.dc;this.dc=null;e.onclose=null;e.onerror=null;if(e.readyState=="open"){try{e.send(new Uint8Array([1]));if(this.gotEof)this.conn.recycleChannel(e);else this.conn.waitForEof(e)}catch(t){}}};function t(e,t,n){this.manager=e;this.pc=t;this.key=n;this.pc.oniceconnectionstatechange=function(){if(this.pc.iceConnectionState!="new"&&this.pc.iceConnectionState!="checking"){delete e.gcmRtcConnections[n]}if(this.pc.iceConnectionState=="disconnected"||this.pc.iceConnectionState=="closed"){this.destroy()}}.bind(this)}t.prototype.waitForCommand=function(t){t.onmessage=function(n){if(n.data.byteLength==1)return;this.removeChannel(t);var i=ab2str(n.data);var o=new e(this,t);this.openSocket(i,o)}.bind(this)};t.prototype.compactChannels=function(){if(this.inboundChannels&&!this.inboundChannels.length)this.inboundChannels=null;if(this.outboundChannels&&!this.outboundChannels.length)this.outboundChannels=null};t.prototype.getAppropriateChannels=function(e,t){var n;if(e.inbound){if(!this.inboundChannels&&t)this.inboundChannels=[];n=this.inboundChannels}else{if(!this.outboundChannels&&t)this.outboundChannels=[];n=this.outboundChannels}return n};t.prototype.removeChannel=function(e){t;channels=this.getAppropriateChannels(e);if(!channels)return;var t=channels.indexOf(e);if(t==-1)return;channels.splice(t,1);this.compactChannels()};t.prototype.waitForEof=function(e){e.onmessage=function(t){var n=new Uint8Array(t.data);var i=n[n.byteLength-1]==1;if(i)this.recycleChannel(e)}.bind(this)};t.prototype.recycleChannel=function(e){var t=this.getAppropriateChannels(e,true);t.push(e);e.onclose=e.onerror=function(){this.removeChannel(e)}.bind(this);this.waitForCommand(e)};t.prototype.addCandidates=function(e){for(var t in e.candidates){this.pc.addIceCandidate(new RTCIceCandidate(e.candidates[t]))}};t.prototype.setupPinger=function(e){var t;function n(){e.send(str2ab("ping"));t=setTimeout(n,1e3)}e.onmessage=function(e){};e.onclose=e.onerror=function(){clearTimeout(t);this.destroy()}.bind(this);n()};t.prototype.listenSockets=function(){this.pc.ondatachannel=function(e){e.channel.inbound=true;this.waitForCommand(e.channel)}.bind(this)};t.prototype.prepareChannel=function(e){var t=this.pc.createDataChannel(e||"gcm",{reliable:true,ordered:true});t.binaryType="arraybuffer";return t};t.prototype.newSocket=function(t,n){if(this.pc.signalingState=="closed"){n();return}if(this.outboundChannels){var i=this.outboundChannels.shift();this.compactChannels();i.send(str2ab(t));var o=new e(this,i);n(o,this);return}var i=this.prepareChannel("gcm");i.onopen=function(){i.send(str2ab(t));var o=new e(this,i);n(o,this)}.bind(this)};t.prototype.destroy=function(){delete this.manager.gcmRtcConnections[this.key];if(this.pc.signalingState!="closed"){this.pc.close()}var e=this.onClose;if(e){delete this.onClose;e()}};function n(e,t,n){this.senders=e;this.registrationId=t;this.rtcc=n;this.gcmRtcConnections={};this.gcmRtcListeners={}}n.prototype.onMessage=function(e){var t=JSON.parse(e.message);var i=e.type;var o=e.senderId;var r=e.src;var s=e.srcPort;var a=e.dstPort;if(i=="offer"){var c=this.gcmRtcListeners[a];if(!c)console.log("not listening on "+a);else c.listener.incoming(o,r,s,a,t,c.listenCallback);return}else if(i=="answer"){var u=n.getKey(r,s,a);var d=this.gcmRtcConnections[u];if(!d){console.log("pending connection not found");return}d.manager.incoming(o,r,s,a,t);return}else if(n.onUnknownMessage){n.onUnknownMessage(e)}else{console.log("unknown message "+i)}};n.hasLoadedChannels=false;n.start=function(e,t,i){console.log("starting GtcRtcManger");if(window.chrome&&window.chrome.gcm){var o=Object.keys(e);chrome.gcm.register(o,function(o){chrome.runtime.lastError;if(!o){i();return}var r=new n(e,o,t);chrome.gcm.onMessage.addListener(function(e){r.onMessage(e.data)});i(r)})}else{function r(){n.hasLoadedChannels=true;var o=new n(e,null,t);function r(e){return function(){var t=arguments;o.ensureChannel().then(function(){e.apply(o,t)})}}o.listen=r(o.listen);o.connect=r(o.connect);o.ensureChannel().then(function(){i(o)})}if(n.hasLoadedChannels){r()}else{$.getScript("https://vysor-1026.appspot.com/_ah/channel/jsapi",r)}}};n.prototype.ensureChannel=function(){var e=this;if(this.channelPromise){return this.channelPromise}return this.channelPromise=new Promise(function(t,n){$.ajax({type:"GET",url:"https://vysor-1026.appspot.com/listen",success:function(n){var i=new goog.appengine.Channel(n.token);var o={onopen:function(){var i="web:"+n.channel;e.registrationId=i;if(e.onRegistrationIdChanged)e.onRegistrationIdChanged(i);t()},onmessage:function(t){e.onMessage(JSON.parse(t.data))},onerror:function(){console.error("gcm onerror",arguments);e.channelPromise=null},onclose:function(){console.error("gcm onclose",arguments);e.channelPromise=null;e.gcmRtcConnections={};if(!Object.keys(e.gcmRtcListeners).length){console.log("not reconnecting, no listeners");return}console.error("reconnecting gcm");e.reconnectTimeout=throttleTimeout(e.reconnectTimeout,null,5*60*1e3,function(){e.ensureChannel()})}};var r=i.open(o)}})})};n.prototype.sendGcm=function(e,t,n,i,o,r){if(!e)e=this.defaultSenderId;if(t.startsWith("web:")){$.ajax({type:"POST",url:"https://vysor-1026.appspot.com/send",data:JSON.stringify({channel:t.substring(4),data:{senderId:e,src:this.registrationId,srcPort:i,dstPort:n,type:o,message:JSON.stringify(r)}}),contentType:"application/json",dataType:"json",success:function(){}})}else{$.ajax({type:"POST",url:"https://gcm-http.googleapis.com/gcm/send",headers:{Authorization:"key="+this.senders[e]},data:JSON.stringify({to:t,data:{senderId:e,src:this.registrationId,srcPort:i,dstPort:n,type:o,message:JSON.stringify(r)}}),contentType:"application/json",dataType:"json",error:function(){console.log("gcm error",arguments)},success:function(){console.log("gcm",arguments)}})}};n.getKey=function(e,t,n){return n+":"+t+":"+e};n.prototype.setupPeerConnection=function(e,i,o,r,s,a){var c=window.RTCPeerConnection||window.webkitRTCPeerConnection;var u=new c(this.rtcc);var d;var l=function(t){var n=[];for(var c in t){c=t[c];n.push(c);if(JSON.stringify(n).length>3200){this.sendGcm(i,o,r,s,e,{desc:a(),candidates:n});n=[]}}if(n.length>0){this.sendGcm(i,o,r,s,e,{desc:a(),candidates:n})}}.bind(this);u.onicecandidate=function(e){if(e.candidate==null)return;console.log(e.candidate);d=throttleTimeout(d,e.candidate,500,l)}.bind(this);var f=n.getKey(o,r,s);var h=new t(this,u,f);u.onsignalingstatechange=function(e){if(u.signalingState=="stable"){if(this.gcmRtcConnections[f]==h){}}else if(u.signalingState=="closed"){h.destroy()}}.bind(this);this.gcmRtcConnections[f]=h;return h};n.gcmPortCount=0;n.prototype.connect=function(e,t){var i=e.senderId;var o=e.registrationId;var r=e.port;var s=n.gcmPortCount++;var a;var c=this.setupPeerConnection("offer",i,o,r,s,function(){return a});var u=c.pc;function d(e){u.createOffer(e).then(function(e){a=e;u.setLocalDescription(e)})}if(!e.audio){var l=c.prepareChannel("pinger");l.onopen=function(){console.log("got rtc pinger");c.setupPinger(l);t(c)};c.listenSockets();d({})}else{navigator.webkitGetUserMedia({audio:true,video:false},function(e){u.addStream(e);u.onaddstream=function(e){console.log("got the remote stream");t(c,e)};d({offerToReceiveAudio:true,offerToReceiveVideo:false,voiceActivityDetection:false})},function(){console.error("audio fail",arguments);d({offerToReceiveAudio:true,offerToReceiveVideo:false,voiceActivityDetection:false})})}};n.prototype.isListening=function(e){return this.gcmRtcListeners[e]!=null};n.prototype.stopListen=function(e){delete this.gcmRtcListeners[e]};n.prototype.listen=function(e,t){if(this.gcmRtcListeners[e]){console.log("already listening on gcm port "+e);return}this.gcmRtcListeners[e]={listener:this,listenCallback:t}};n.prototype.incoming=function(e,t,i,o,r,s){var a=n.getKey(t,i,o);var c=this.gcmRtcConnections[a];if(!c){var u;c=this.setupPeerConnection("answer",e,t,i,o,function(){return u});c.remoteDesc=new RTCSessionDescription(r.desc);var d=c.pc;d.ondatachannel=function(e){console.log("got rtc pinger");this.setupPinger(e.channel);s(c);this.listenSockets()}.bind(c);d.setRemoteDescription(c.remoteDesc,function(){d.createAnswer().then(function(e){u=e;d.setLocalDescription(e)},function(){console.error("answer error",arguments)})})}else if(!c.remoteDesc){c.remoteDesc=new RTCSessionDescription(r.desc);var d=c.pc;d.setRemoteDescription(c.remoteDesc)}else{}c.addCandidates(r)};window.GcmRtcSocket=e;window.GcmRtcManager=n})();function FileSocket(e){this.internalRead=this.read;this.read=this.readWrapper;this.file=e;this.fileRead=0}FileSocket.prototype.write=function(e,t){throw new Error("write not supported on file socket")};FileSocket.prototype.destroy=function(){};FileSocket.prototype.buffered=Socket.prototype.buffered;FileSocket.prototype.unshift=Socket.prototype.unshift;FileSocket.prototype.dataReceived=Socket.prototype.dataReceived;FileSocket.prototype.read=Socket.prototype.read;FileSocket.prototype.pause=Socket.prototype.pause;FileSocket.prototype.resume=Socket.prototype.resume;FileSocket.prototype.buffered=Socket.prototype.buffered;FileSocket.prototype.onPause=function(){};FileSocket.prototype.onResume=function(){};FileSocket.prototype.readWrapper=function(){this.internalRead.apply(this,arguments);if(!this.pendingCallback)return;var e=this.pendingLength;if(!e)e=65536;e=Math.min(this.file.size-this.fileRead,e);if(e==0){this.dataReceived(null);return}var t=this.file.slice(this.fileRead,this.fileRead+e);this.fileRead+=e;var n=new FileReader;n.addEventListener("loadend",function(e){this.dataReceived(new Uint8Array(n.result))}.bind(this));n.readAsArrayBuffer(t)};(function(){var e={};e.sendHostCommand=function(e,t){Socket.connect({host:"127.0.0.1",port:5037},function(n){if(!n){t();return}var i=e;e=make4Len16(e.length)+e;n.read(4,function(e){var o=ab2str(e);if(o!="OKAY"){console.error("error in response to adb host command",i,o);n.destroy();t();return}n.read(4,function(e){var i=ab2str(e);e=parseInt(i,16);if(e==0||i=="OKAY"){t(n,new ArrayBuffer(0));return}n.read(e,function(e){t(n,e)})})});n.write(str2ab(e),function(){})})};e.devices=function(t){var n={};function i(e){var t=e;e=e.replace("\t"," ");var i=e.indexOf(" ");if(i==-1)return;var o=e.substring(0,i);e=e.substring(i).trim();var r;while(r!=e){r=e;e=e.replace("  "," ")}var s={};var a=e.indexOf(" ");if(a==-1)a=e.length;var c=e.substring(0,a);e=e.substring(a+1);while(e.length){i=e.indexOf(":");if(i==-1)break;var u=e.substring(0,i);var d=e.substring(i+1);var l=d.indexOf(" ");var f=d.indexOf(":");var h;if(l==-1||f==-1){h=d;e=""}else{while(l!=-1&&l<f){h=d.substring(0,l);e=d.substring(l+1);l=d.indexOf(" ",l+1)}}s[u]=h}var p;if(!s["model"])p=o;else p=s["model"].replace("_"," ");n[o]={serialno:o,name:p,status:c,properties:t}}e.sendHostCommand("host:devices-l",function(e,o){if(!e){t();return}e.destroy();o=ab2str(o);console.log("ADB devices:",o);o=o.trim();var r=o.split("\n");for(var s in r){s=r[s];i(s)}t(n)})};e.killServer=function(t){e.sendHostCommand("host:kill-server",function(e,n){if(!e){t();return}e.destroy();n=ab2str(n);if(t)t()})};e.sendClientCommand=function(e,t){var n=e.command;var i=e.serialno;Socket.connect({host:"127.0.0.1",port:5037},function(e){if(!e){t();return}e.read(4,function(i){var o=ab2str(i);if(o!="OKAY"){e.destroy();t(null);return}var r=n;r=make4Len16(r.length)+r;e.read(4,function(n){var i=ab2str(n);if(i!="OKAY"){e.destroy();t(null);return}t(e)});e.write(str2ab(r),function(){})});var o="host:transport:"+i;o=make4Len16(o.length)+o;e.write(str2ab(o),function(){})})};e.shell=function(t,n){var i=t.command;var o=t.serialno;e.getOrCreateSockFactory(t).newSocket("shell:"+i,function(e){if(!e){n();return}readString(e,function(e){n(e)})})};e.forward=function(t,n){var i="host-serial:"+t.serialno+":forward:"+t.from+";"+t.to;e.sendHostCommand(i,function(e,t){if(e)e.destroy();n(e,t)})};function t(){}t.MKID=function(e,t,n,i){return e.charCodeAt(0)|t.charCodeAt(0)<<8|n.charCodeAt(0)<<16|i.charCodeAt(0)<<24};t.ID_RECV=t.MKID("R","E","C","V");t.ID_SEND=t.MKID("S","E","N","D");t.ID_DONE=t.MKID("D","O","N","E");t.ID_DATA=t.MKID("D","A","T","A");t.DATA_MAX=64*1024;e.pull=function(n,i){var o=n.file;var r=n.serialno;var s=n.fileEntry;var a=n.socket;if(!a){(function(){var e;a={write:function(t,n){if(!e){s.createWriter(function(i){e=i;a.write(t,n)});return}e.onwriteend=n;e.write(new Blob([t]))}}})()}var c=new DummySocket;Socket.pump(c,a,function(){i(s)});e.getOrCreateSockFactory(n).newSocket("sync:",function(e){if(!e){i();return}function n(t){e.read(t,function(e){c.dataReceived(e);r()})}function r(){e.read(8,function(o){var r=new DataView(o.buffer,o.byteOffset,o.byteLength);var s=r.getUint32(0,true);if(s==t.ID_DATA){var a=r.getUint32(4,true);n(a);return}e.destroy();if(s==t.ID_DONE){c.dataReceived(null);return}i()})}var s=new ArrayBuffer(8);var a=new DataView(s);a.setUint32(0,t.ID_RECV,true);a.setUint32(4,o.length,true);e.write(s,function(){e.write(str2ab(o),function(){r()})})})};e.createSocketFactory=function(t){return{newSocket:function(n,i){e.sendClientCommand({serialno:t,command:n},i)}}};e.getOrCreateSockFactory=function(t){return t.socketFactory||e.createSocketFactory(t.serialno)};e.push=function(n,i){var o=n.file;var r=n.serialno;var s=n.socket;e.getOrCreateSockFactory(n).newSocket("sync:",function(e){if(!e){i();return}var n=new ArrayBuffer(8);var r=new DataView(n);var a=o+",0644";r.setUint32(0,t.ID_SEND,true);r.setUint32(4,a.length,true);e.write(n,function(){e.write(str2ab(a),function(){var n;var o=true;s.onClose=function(){var n=new ArrayBuffer(8);var o=new DataView(n);o.setUint32(0,t.ID_DONE,true);o.setUint32(4,0,true);e.write(n,function(){e.read(8,function(){i()})})};function r(){s.read(function(e){if(e.byteLength>t.DATA_MAX){var n=e.subarray(t.DATA_MAX);e=e.subarray(0,t.DATA_MAX);s.unshift(n)}a(e)})}function a(n){var i=new ArrayBuffer(8);var o=new DataView(i);o.setUint32(0,t.ID_DATA,true);o.setUint32(4,n.byteLength,true);e.write(i,function(){var t=n.buffer;if(n.byteOffset||n.length!=t.byteLength){t=t.slice(n.byteOffset,n.byteOffset+n.byteLength)}e.write(t,function(){r()})})}r()})})})};window.Adb=e})();function getDefaultDeviceSettings(){var e={showSoftKeys:true,pinTitleBar:true,alwaysOnTop:false,bitrate:0,resolution:0,decoder:0,displaySettings:commonDisplaySettings[0],resetDisplaySettings:false};return e}function sanitizeDeviceSettings(e){if(!e)return null;if(e.friendlyName&&!e.friendlyName.length)delete e.friendlyName;return e}function loadAllDeviceSettings(e){if(window.chrome&&window.chrome.storage){chrome.storage.local.get("device-settings",function(t){e(t["device-settings"]||{})})}else{e({})}}function loadDeviceSettings(e,t){
if(!e)e="web";var n=getDefaultDeviceSettings();if(e=="inkwire"){n.pinTitleBar=false;n.showSoftKeys=false}loadAllDeviceSettings(function(i){t(sanitizeDeviceSettings(i[e]||n))})}function saveDeviceSettings(e,t,n){sanitizeDeviceSettings(t);if(!window.chrome||!window.chrome.storage){if(n)n();return}if(!e||e.indexOf("127.0.0.1")!=-1){if(n)n();return}loadAllDeviceSettings(function(i){i[e]=t;chrome.storage.local.set({"device-settings":i},n)})}function populateDisplaySettings(){for(var e in commonDisplaySettings){var t=commonDisplaySettings[e];var n=new Option;$(n).html(t.name);$("#display-settings").append(n)}}function applyDeviceSettings(e){$("#new-display-name").prop("value",e.friendlyName||null);$("#softkeys-check").prop("checked",e.showSoftKeys?true:false).change();$("#pin-title-check").prop("checked",e.pinTitleBar?true:false).change();$("#always-on-top-check").prop("checked",e.alwaysOnTop?true:false).change();$("#bitrate").prop("selectedIndex",e.bitrate||0);$("#decoder").prop("selectedIndex",e.decoder||0);$("#resolution").prop("selectedIndex",e.resolution||0);var t=e.displaySettings&&e.displaySettings.name;var n=0;for(var i in commonDisplaySettings){var o=commonDisplaySettings[i];if(o.name==t){n=i;break}}$("#display-settings").prop("selectedIndex",n);$("#reset-display-settings").prop("checked",e.resetDisplaySettings?true:false)}var commonDisplaySettings=[{name:"Default Settings",size:"reset",density:"reset"},{name:"Resizable (96dpi)",size:"reset",density:"96",freeSize:true},{name:"Resizable (144dpi)",size:"reset",density:"144",freeSize:true},{name:"1080p (96dpi)",size:"1920x1080",density:"96"},{name:"4K (144dpi)",size:"3840x2160",density:"144"},{name:"Galaxy Nexus",size:"720x1280",density:"320"},{name:"Nexus 4",size:"768x1280",density:"320"},{name:"Nexus 5",size:"1080x1920",density:"480"},{name:"Nexus 6",size:"1440x2560",density:"560"},{name:"Nexus 6p",size:"1440x2560",density:"560"},{name:"Nexus 7 (2012)",size:"800x1280",density:"213"},{name:"Nexus 7 (2013)",size:"1200x1920",density:"320"},{name:"Nexus 9",size:"1536x2048",density:"320"}];function showModal(e){var t=$("#notificationModal");var n=t.find("#modal-ok");var i=t.find("#modal-cancel");n.unbind("click");i.unbind("click");t.unbind("hidden.bs.modal");e.cancelButton=e.cancelButton||"Cancel";e.okButton=e.okButton||"OK";e.title=e.title||chrome.runtime.getManifest().name;e.body=e.body||"";if(e.hideCancel)i.hide();else i.show();n.text(e.okButton);i.text(e.cancelButton);t.find("#modal-title").text(e.title);t.find("#modal-body").html(e.body);var o;n.click(function(){o=true;if(!e.ok||!e.ok())$("#notificationModal").modal("hide")});if(e.cancel){t.on("hidden.bs.modal",function(){if(!o)e.cancel()});i.click(e.cancel)}$("#notificationModal").modal();if(e.duration){setTimeout(function(){$("#notificationModal").modal("hide")},e.duration)}}function shortModal(e,t){showModal({title:e,body:t,duration:8e3,hideCancel:true})}(function(){var e=9;var t=8;var n=9;var i=18;var o=0;var r=1;var s=2;var a=3;var c=5;var u=6;var d=7;var l=8;var f=9;var h=10;var p=11;var y=12;var v=13;var g=0;var m=7;var w=4;var b=1<<w|7;var k=2<<w|7;function S(e,t,n,i){this.socket=e;this.videoOnly=true;var o=new ByteBuffer(1024);o.put("FLV");o.put(1);if(this.videoOnly)o.put(1);else o.put(1+4);o.putInt(9);o.putInt(0);o.flip();this.socket.dataReceived(o);this.setParameter(t,n,i)}function C(e,t){e.put(o);e.putDouble(t);return e}function D(e,t){var n=str2ab(t);e.putShort(n.byteLength);e.put(n);return e}function A(e,t){e.putShort(t>>8&65535);e.put(t&255);return e}S.prototype.setParameter=function(t,n,o){var r=new ByteBuffer(1024);r.put(i);if(this.videoOnly)A(r,182);else A(r,290);A(r,0);r.putInt(0);var a=r.position;r.put(s);D(r,"onMetaData");r.put(l);if(this.videoOnly)r.putInt(5+2);else r.putInt(5+5+2);D(r,"duration");C(r,0);D(r,"width");C(r,t);D(r,"height");C(r,n);D(r,"framerate");C(r,o);D(r,"videocodecid");C(r,m);D(r,"videodatarate");C(r,0);if(!this.videoOnly){D(r,"audiodatarate");C(r,64e3/1024);D(r,"audiosamplerate");C(r,5112);D(r,"audiosamplesize");C(r,8);D(r,"stereo");r.put(0);D(r,"audiocodecid");C(r,0)}D(r,"encoder");r.put(s);D(r,"Lavf52.87.1");D(r,"filesize");C(r,0);D(r,"");r.put(e);var c=r.position;var u=c-a;r.putInt(u+11);r.flip();this.socket.dataReceived(r)};S.prototype.addVideoHeader=function(e){for(var t=4;t<e.length;t++){if(e[t+0]==0&&e[t+1]==0&&e[t+2]==0&&e[t+3]==1){break}}var i=e.subarray(0,t);var o=e.subarray(t);var r=new ByteBuffer(1024);var s=i.length-4+o.length-4+16;r.put(n);A(r,s);A(r,0);r.put(0);A(r,0);r.put(7|b);r.put(0);A(r,0);r.put(1);r.put(i[4+1]);r.put(i[4+2]);r.put(i[4+3]);r.put(255);r.put(225);r.putShort(i.length-4);r.put(i.subarray(4));r.put(1);r.putShort(o.length-4);r.put(o.subarray(4));r.putInt(11+s);r.flip();this.socket.dataReceived(r)};S.prototype.addVideoFrame=function(e,t,i){var o=new ByteBuffer(1024);o.put(n);A(o,5+e.length);if(!this.firstPresentationTimestampMs)this.firstPresentationTimestampMs=t;var r=t-this.firstPresentationTimestampMs;A(o,r);o.put(r>>24&255);A(o,0);o.put(i?b:k);o.put(1);A(o,0);o.flip();var s=new ByteBuffer(e.length);s.put(e);s.flip();s.putInt(e.length-4);s.position=0;var a=new ByteBuffer(1024);a.putInt(11+5+e.length);a.flip();this.socket.dataReceived(o);this.socket.dataReceived(s);this.socket.dataReceived(a)};window.FlashPackager=S})();var h264Socket;var inputWebSocket;(function(){var e;var t;var n;var i;var o;var r;var s;var a;var c;var u=36;var d=48;var l;var f;var h;var p;var y;var v;var g=vysorDefaultSettings;window.siphonFlv=function(e){if(p){p.destroy();p=null;y=null}p=e;if(p){y=new FlashPackager(p,r,s,30);v=true;S({type:"resolution",resolution:resolution})}};var m=[0,.25,.5,.75,1];var w=[5e5,75e4,1e6,15e5,2e6,3e6,4e6];var b=["software","hardware","hardware_with_fallback"];var k=function(e,t){return t};if(!window.tracker){window.tracker={sendEvent:function(){},sendAppView:function(){}}}function S(e){if(!inputWebSocket)return;if(e.clientX){e.downDelta=Date.now()-f;if(!l)l=$("#mirror");e.clientX=e.clientX/l.width()*i;if(e.clientX>i||e.clientX<0)return}if(e.clientY){if(!l)l=$("#mirror");e.clientY=e.clientY/l.height()*o;if(e.clientY>o||e.clientY<0)return}inputWebSocket.send(JSON.stringify(e))}function C(e,t){if(!e)return;if(e.constructor.name=="String"){if(e.startsWith("KEYCODE_")){S({type:"keyevent",keyevent:e});return true}else{switch(e){case"VYSOR_SHOW_TITLE_BAR":D();break;default:return}return true}}else if(e.constructor.name=="Number"){S({type:"keycode",keycode:e});return true}else{if(e.keyevent){S({type:"keyevent",keyevent:e.keyevent,shift:e.shiftKey&&t&&t.shiftKey?true:false});return true}else if(e.keycode){S({type:"keycode",keycode:e.keycode,shift:e.shiftKey&&t&&t.shiftKey?true:false});return true}}}function D(){if(t=="inkwire"){$(".head").hide();return}if(u){clearTimeout(n);$(".head").fadeTo(0,1);return}$(".head").fadeTo(0,.8);clearTimeout(n);n=setTimeout(function(){$(".head").fadeOut()},2e3)}$(window).focus(function(){D();S({type:"wakeup"})});$(window).bind("paste",function(e){var t=e.originalEvent.clipboardData.getData("text");if(t&&t.length){S({type:"keychar",keychar:t})}});window.addEventListener("mousewheel",function(e){S({type:"scroll",clientX:e.offsetX,clientY:e.offsetY,deltaX:e.wheelDeltaX/100,deltaY:e.wheelDeltaY/100})},false);$(window).keypress(function(e){var t=String.fromCharCode(e.keyCode);if(!t.length)return;S({type:"keychar",keychar:t})});$(window).keydown(function(e){if(C(g.keydown[e.keyCode]||g.keydown[e.key],e)){e.stopPropagation()}});var A;$(window).resize(function(t){if(!o||!i)return;clearTimeout(A);A=setTimeout(function(){if(!L()){var t=innerWidth;var n=t*(o/i);a=t;c=n;x()}else{S({type:"displaySettings",size:innerWidth+"x"+(innerHeight-u-d),density:e.displaySettings.density})}},500)});function R(e,t){if(L()){a=i;c=o}else{if(window.chrome&&window.chrome.app&&window.chrome.app.window&&T()){a=screen.availWidth;c=screen.availHeight}if(t==i&&e==o){var n=a;a=c;c=n}else{var r;if(i>o)r=Math.max(innerWidth,innerHeight);else r=Math.min(innerWidth,innerHeight);var s=r*(o/i);a=r;c=s}}x()}function I(){return!window.chrome||!window.chrome.app||!window.chrome.app.window}function T(){return document.webkitFullscreenElement||document.msFullscreenElement||document.mozFullscreenElement||document.fullscreenElement}function L(){return e&&e.displaySettings&&e.displaySettings.freeSize}function x(){var e=innerWidth;var t=innerHeight;var n=screen.availWidth;var r=screen.availHeight;if(T()||L()||I()){n=e;r=t}if(a>n){a=n;c=o/i*a}var s=0;if(c+d+u+s>r){c=r-d-u-s;a=i/o*c}if(!a||!c)return;var l=Math.round(a);var f=Math.round(c+d+u);if(!T()&&!L()){if(isElectron()){if(Math.abs(innerWidth-l)>=2||Math.abs(innerHeight-f)>=2)chrome.app.window.current().w.setContentSize(l,f)}else if(window.chrome&&window.chrome.app&&window.chrome.app.window){if(Math.abs(innerWidth-l)>=2)chrome.app.window.current().innerBounds.width=l;if(Math.abs(innerHeight-f)>=2)chrome.app.window.current().innerBounds.height=f}}var h=(e-a)/2;var p=$("#mirror, #listener");p.css("left",h);p.css("top",(t-c-d+u)/2);$(".foot").width(a);$(".foot").css("left",h);$(".overlay").width(a);$(".overlay").css("left",h);p=$("#mirror, embed, #listener");p.width(Math.round(a));p.height(Math.round(c));var y=$("canvas")[0];y.width=Math.round(a);y.height=Math.round(c);$("#dead, #drag, #reconnect").width(a);$("#dead, #drag, #reconnect").height(c+d+u)}function F(e){if(!window.chrome||!window.chrome.storage)return;chrome.storage.local.get(["vysorUsage","vysorDailyUsage","lastDailyReport"],function(t){var n=t.vysorUsage;var i=t.lastDailyReport;var o=t.vysorDailyUsage;var r=Date.now();if(!n)n=0;if(!o)o=0;if(!i){chrome.storage.local.set({lastDailyReport:r})}else{if(r>i+24*60*60*1e3){var s=o/(60*60*1e3);s=Math.round(s*2)/2;if(s<=24&&s>=0){tracker.sendEvent("daily-usage",s.toString());tracker.sendEvent("daily-usage-licensed",licenseManager.isLicensed)}o=0;chrome.storage.local.set({lastDailyReport:r})}}n+=e;o+=e;chrome.storage.local.set({vysorUsage:n,vysorDailyUsage:o})})}function E(){$("#listener").empty();var t;var n;var i;if(isElectron()){t="host";n=null;i="application/x-ppapi-vysor"}else{t="pnacl";n="video_decode/pnacl/Release";i=null}common.createNaClModule("video_decode",i,t,n,r,s,{},function(e){if(e.data=="decoder-falling-behind"){if(this.onDecoderFallingBehind)this.onDecoderFallingBehind()}else if(e.data=="decoder-ready"){if(this.onReady)this.onReady();else console.error("no listener for decoder-ready")}}.bind(this),function(){console.log("NACL module initialized");var t=b[e.decoder||0];console.log("decoder:",t);common.naclModule.postMessage(t)}.bind(this));x()}E.prototype.decode=function(e,t,n){if(!common.naclModule||!common.naclModule.postMessage){console.error("decode called before initialization");return}common.naclModule.postMessage({buffer:e.buffer,byteOffset:e.byteOffset,byteLength:e.byteLength,presentationTimeMs:t,syncFrame:n})};function O(e){if(!e){if(document.exitFullscreen)document.exitFullscreen();else if(document.webkitExitFullscreen)document.webkitExitFullscreen();else if(document.mozExitFullscreen)document.mozExitFullscreen();else if(document.mskitExitFullscreen)document.mskitExitFullscreen()}else{if(document.documentElement.requestFullscreen)document.documentElement.requestFullscreen();else if(document.documentElement.webkitRequestFullscreen)document.documentElement.webkitRequestFullscreen();else if(document.documentElement.msRequestFullscreen)document.documentElement.msRequestFullscreen();else if(document.documentElement.mozRequestFullScreen)document.documentElement.mozRequestFullScreen()}}function M(){$(".foot-row").empty();var e=g.navigationBar.buttons;var t=Math.round(100/e.length)+"%";$(e).each(function(e,n){var i=$("<span></span>");i.attr("class",n.class);i.attr("title",n.title);i.width(t);i.click(function(){C(n.event)});$(".foot-row").append(i)})}sharedGlobals.docReady=function(){if(!window.licenseManager){k=function(e,t){return t}}else{k=function(e,t,n){return function(){if(h&&!licenseManager.isLicensed){showModal({title:"Vysor Pro",body:"The "+e+" feature is only available to Vysor Pro users.",okButton:"Upgrade",ok:function(){licenseManager.startPurchase()}});if(n)n.apply(this,arguments);return}t.apply(this,arguments)}}}var t;$(document).on("dragover",function(e){$("#drag").fadeIn();clearTimeout(t);e.preventDefault();e.stopPropagation()});$(document).on("dragleave",function(){t=setTimeout(function(){$("#drag").fadeOut()},1e3)});$(document).on("drop",k("Drag and Drop",function(e){$("#drag").fadeOut();e.preventDefault();if(e.originalEvent.dataTransfer.files.length!=1){showNotification("You may only drag and drop one file at a time.");return}var t=e.originalEvent.dataTransfer.files[0];console.log(t);Adb.push({socketFactory:adbSocketFactory,socket:new FileSocket(t),file:"/sdcard/vysor/"+t.name,serialno:device.serialno},function(){var e="am start -a android.intent.action.VIEW -d file:/sdcard/vysor/"+t.name;if(t.type&&t.type.length){e+=" -t "+t.type}else if(t.name.endsWith(".apk")){Adb.shell({socketFactory:adbSocketFactory,command:"pm install -r /sdcard/vysor/"+t.name,serialno:device.serialno},function(e){showNotification("APK installation result: "+e.trim())});return}Adb.shell({socketFactory:adbSocketFactory,command:e,serialno:device.serialno},function(){showNotification("File has been transfered and is being opened on the Android.")})})},function(e){$("#drag").fadeOut();e.preventDefault()}));common.attachDefaultListeners();$("canvas, #listener").mouseup(function(e){if(e.button!=0)return;S({type:e.type,clientX:e.offsetX,clientY:e.offsetY})});$("canvas, #listener").bind("touchstart touchend touchmove",function(e){var t;if(e.type=="touchstart")t="mousedown";else if(e.type=="touchend")t="mouseup";else t="mousemove";var n=e.currentTarget;e.stopPropagation();e.preventDefault();e=e.originalEvent;var i=e.touches[0];if(!i)i=e.changedTouches[0];var o=document.createEvent("MouseEvent");o.initMouseEvent(t,true,true,window,e.detail,i.screenX,i.screenY,i.clientX,i.clientY,false,false,false,false,0,null);o.isTouch=true;n.dispatchEvent(o)});console.log("docReady");$("canvas, #listener").mousedown(function(e){f=Date.now();if(e.button==1){S({type:"home"});return}if(e.button==2){S({type:"back"});return}if(e.button!=0)return;S({type:e.type,clientX:e.offsetX,clientY:e.offsetY})});$("canvas, #listener").mousemove(function(e){if((e.buttons&1)==0&&!e.originalEvent.isTouch)return;S({type:e.type,clientX:e.offsetX,clientY:e.offsetY})});$(".head").bind("mouseup mousedown mousemove",function(e){e.stopPropagation();D()});$("#rotate-button").click(function(){S({type:"rotate"})});$("#screenshot-button").click(function(){chrome.browser.openTab({url:"http://127.0.0.1:"+httpPort+"/device/"+(device.id||device.serialno)+"/screenshot.jpg"})});$("#record-button").click(k("Record Screen",function(){if($("#record-button>span").hasClass("fa-video-camera")){S({type:"start-recording"})}else{S({type:"stop-recording"})}$("#record-button>span").toggleClass("fa-video-camera fa-stop-circle-o")}));if(!window.chrome||!window.chrome.app||!window.chrome.app.window){$("#screenshot-button").hide();$("#record-button").hide()}$("#power").click(function(){S({type:"keycode",keycode:26})});$("#volume-down").click(function(){S({type:"keycode",keycode:25})});$("#volume-up").click(function(){S({type:"keycode",keycode:24})});M();$("#reconnect-button").click(function(){tryReconnect();$("#reconnect").hide()});$("#settings-button").click(function(){showSettings();openList()});$("#web-video-stream").click(k("Web Video Stream",function(){var e=$("#web-video-stream").text();$("#settings-modal").modal("hide");copyTextToClipboard(e);setTimeout(function(){shortModal("Copied Web Video Stream Link",e)},500)}));function n(){saveDeviceSettings(device.id||device.serialno,e)}var i=$("#new-display-name");function o(){$("#settings-modal").modal("hide");var t=$(i).prop("value");e.friendlyName=t;$(".title, title").text(e.friendlyName||device.name);n();var o=chrome.app.window.get("list");if(o&&o.contentWindow.updateDeviceName)o.contentWindow.updateDeviceName(device.id||device.serialno,e.friendlyName||device.name)}$(i).bind("keypress",function(e){e.stopPropagation();var t=e.which;if(t==13){o();return false}});$("#settings-ok").click(o);$("#settings-defaults").click(function(){e=getDefaultDeviceSettings();try{h=false;applyDeviceSettings(e)}finally{h=true}S({type:"displaySettings",size:"reset",density:"reset",resolution:m[e.resolution]})});$("#softkeys-check").change(function(){e.showSoftKeys=this.checked;if(this.checked){$(".foot").show();d=48}else{$(".foot").hide();d=0}x()});$("#pin-title-check").change(function(){e.pinTitleBar=this.checked;if(this.checked)u=36;else u=0;x();D()});$("#fullscreen-check").change(k("Fullscreen Mode",function(){O(this.checked)},function(){this.checked=false}));$("#always-on-top-check").change(k("Always On Top",function(){e.alwaysOnTop=this.checked;if(window.chrome&&window.chrome.app&&window.chrome.app.window)chrome.app.window.current().setAlwaysOnTop(this.checked)},function(){this.checked=false}));$("#bitrate").change(k("Video Quality",function(){e.bitrate=this.selectedIndex;var t=w[this.selectedIndex];S({type:"bitrate",bitrate:t})},function(){this.selectedIndex=0}));$("#resolution").change(k("Video Resolution",function(){e.resolution=this.selectedIndex;var t=m[this.selectedIndex];S({type:"resolution",resolution:t})},function(){this.selectedIndex=0}));$("#decoder").change(k("Video Decoder",function(){e.decoder=this.selectedIndex;S({type:"resolution",resolution:m[e.resolution]})},function(){this.selectedIndex=0}));$("#display-settings").change(k("Display Settings",function(){var t=commonDisplaySettings[this.selectedIndex];var i=t.freeSize?innerWidth+"x"+(innerHeight-u-d):t.size;e.displaySettings=t;e.resetDisplaySettings=this.selectedIndex!=0;n();$("#reset-display-settings").prop("checked",e.resetDisplaySettings);S({type:"displaySettings",size:i,density:t.density});if(this.selectedIndex){showModal({title:"Display Settings",body:"Please close the Vysor window before disconnecting your Android to reset your Display Settings.",hideCancel:true})}},function(){this.selectedIndex=0}));$("#reset-display-settings").change(function(){e.resetDisplaySettings=this.checked;n();S({type:"resetDisplaySettings",resetDisplaySettings:this.checked})});populateDisplaySettings();x();D();if(window.tracker)tracker.sendAppView("screen")};var B;function U(){if(!window.licenseManager)return;if(!B&&licenseManager.isLicensed)return;var t=[];for(var n=1;n<=8;n++)t.unshift(n);var i=t.length+1;$(t).each(function(e){setTimeout(function(){$(".title, title").text("Ad in "+e+" seconds.")},(i-e)*1e3)});setTimeout(function(){$(".title, title").text(e.friendlyName||device.name);S({type:"ad"})},i*1e3)}var P;function N(){if(!window.licenseManager)return;if(!B&&licenseManager.isLicensed)return;clearInterval(P);P=setInterval(U,30*60*1e3);U()}sharedGlobals.connectionReady=function(){console.log("connectionReady");$("#loading").fadeIn();$("#dead, #reconnect").fadeOut();D();if(!device)console.error("device not defined on window object?");if(window.chrome&&window.chrome.storage&&window.chrome.storage.local){chrome.storage.local.get("vysorSettings",function(e){g={};Object.assign(g,e.vysorSettings||vysorDefaultSettings);var t=g.devices&&g.devices[device.id||device.serialno]||{};g.navigationBar=t.navigationBar||g.navigationBar;Object.assign(g.keydown,t.keydown);M()})}loadDeviceSettings(device.id||device.serialno,function(t){e=t;if(!window.licenseManager||!window.licenseManager.isLicensed){e.bitrate=0;e.resolution=0;e.alwaysOnTop=false}applyDeviceSettings(e);h=true;x();$(".title, title").text(e.friendlyName||device.name)});var t;function n(e){if(e.type=="displaySize"){var n=i;var a=o;i=e.screenWidth;o=e.screenHeight;R(n,a)}else if(e.type=="encodeSize"){r=e.encodeWidth;s=e.encodeHeight;if(!h264Socket){k();return}t=throttleTimeout(t,null,1e3,function(){h264Socket.onClose=null;h264Socket.destroy();h264Socket=null;k()})}else if(e.type=="clip"){copyTextToClipboard(e.clip)}else if(e.type=="password"){}else if(e.type=="recording"){var c=e.recording.replace("/sdcard/vysor/","");chrome.browser.openTab({url:"http://127.0.0.1:"+httpPort+"/device/"+(device.id||device.serialno)+"/sdcard-vysor/"+c})}else{console.log("unknown",e)}}var a=0;var c=5;function l(){console.log("input websocket failed, retrying. attempt "+a+" out of "+c);setTimeout(f,2e3)}function f(){a++;if(a==c){b();return}p(function(t){if(!t){l();return}inputWebSocket=t;inputWebSocket.onopen=function(){console.log("input websocket opened");inputWebSocket.onerror=null;var t=e.displaySettings||{};var n=t.freeSize?innerWidth+"x"+(innerHeight-d-u):t.size=="reset"?null:t.size;var i=t.density=="reset"?null:t.density;S({type:"password",password:password,resolution:m[e.resolution],size:n,density:i})};inputWebSocket.onerror=l;inputWebSocket.onmessage=function(e){console.log("event from phone",e.data);var t=JSON.parse(e.data);n(t)}})}if(!window.adbSocketFactory){if(adbSocketFactoryFactory.type=="adb-client"){adbSocketFactory=Adb.createSocketFactory(adbSocketFactoryFactory.arguments.serialno)}else{console.error("unknown adb socket factory factory",adbSocketFactoryFactory.type)}}var p=function(e){adbSocketFactory.newSocket("tcp:53518",function(t){if(!t){e();return}var n;var i=function(){if(!n)return;var e;if(n.length)e=n.shift();else n=null;if(e)writeLine(t,e,i)};t.close=t.destroy.bind(t);t.send=function(e){if(n){n.push(e);return}n=[];writeLine(t,e,i)}.bind(t);e(t);var o=false;t.onClose=function(){if(!o){if(t.onerror)t.onerror()}};function r(e){if(!o){o=true;if(t.onopen)t.onopen()}if(t.onmessage)t.onmessage({data:e});readLine(t,r)}readLine(t,r)})};console.log("init");function b(t){console.log("received socket",t);if(h264Socket){h264Socket.destroy()}h264Socket=t;$(".overlay").fadeOut();if(!t){$("#dead").fadeIn();$("#listener").empty();return}t.name="h264";t.onClose=function(){try{if(window.tryReconnect){$("#reconnect").fadeIn()}else{$("#dead").fadeIn()}$("#listener").empty()}catch(e){console.log("eating error that occurs with jquery if window is being closed...")}console.log("closing input ");if(inputWebSocket)inputWebSocket.close();inputWebSocket=null;if(h264Socket==t)h264Socket=null};var n=new E;var i=true;var o;var r=function(e){var r=e.subarray(8);var s=new DataView(e.buffer,e.byteOffset,8);var c=s.getUint32(0,true);var u=s.getUint32(4,true)!=0;if(y){if(t==h264Socket){if(i)y.addVideoHeader(r);else if(!v)y.addVideoFrame(r,c,u)}}if(i){v=false;i=false}n.decode(r,c,u);var d=Date.now();if(!o){o=d;tracker.sendEvent("view-device")}else{var l=d-o;if(l>60*1e3){o=d;F(l)}}a()};var s=function(e){if(e.byteLength!=4){throw new Error("WTF")}var n=new DataView(e.buffer,e.byteOffset,4);var i=n.getInt32(0,true);t.read(i,r)};var a=function(){t.read(4,s)};function c(){console.log("starting read loop");var n=setTimeout(function(){showNotification("Your Android screen is unavailable right now. This can sometimes be resolved by rebooting your Android.")},5e3);N();t.read(4,function(t){clearTimeout(n);s(t);if(!window.chrome||!window.chrome.storage)return;S({type:"bitrate",bitrate:w[e.bitrate]})})}var u;function d(){u=throttleTimeout(u,null,1e3,function(){console.log("requesting sync frame");S({type:"sync-frame"})})}n.onDecoderFallingBehind=d;n.onReady=c}function k(){adbSocketFactory.newSocket("tcp:53517",function(e){if(!e){b();return}writeLine(e,password,function(){b(e)})})}f()};if(!window.chrome||!window.chrome.app||!window.chrome.app.window){device={id:"web",serialno:"web"};t=getQueryVariable("mode");if(t=="inkwire"){device={id:"inkwire",serialno:"inkwire"}}$(document).ready(function(){docReady();if(t=="inkwire"){$("title").text("Inkwire");u=0;$(".foot").hide();d=0;x()}var e=getQueryVariable("registrationId");if(!e)return;var n=getQueryVariable("senderId");if(!n)n="64148182473";var i=getQueryVariable("audio");if(t=="inkwire"){n="3505780036";i=true}var o;GcmRtcManager.start({3505780036:"AIzaSyDt0GimPRhk8_d_4XjOYzQUn50UkvXhMtE",64148182473:"AIzaSyDd7k1v017osyYbIC92fyf-36s3pv0z73U"},{iceServers:[{url:"turn:n0.clockworkmod.com",username:"foo",credential:"bar"},{url:"turn:n1.clockworkmod.com",username:"foo",credential:"bar"}]},function(t){console.log("attempting to connect to vysor from web");o=t;o.sharedDevices={};var r=getQueryVariable("channel");o.connect({senderId:n,registrationId:e,port:r},function(o){console.log("web connection established");if(i){console.log("attempting audio");t.connect({senderId:n,registrationId:e,port:r,audio:true},function(e,t){console.log("got audio");var n=new Audio;var i=t.stream.getAudioTracks()[0];n.src=(URL||webkitURL||mozURL).createObjectURL(t.stream);n.play()})}console.log("gcmConn",o);adbSocketFactory=o;console.log("starting remote vysor daemon");o.newSocket("webstart",function(e){console.log("waiting for password");readLine(e,function(t){e.destroy();console.log("got password",t);window.password=t;connectionReady()})})})})})}else{$(document).ready(docReady);(function(){function e(){if(!T()){showSettings();shortModal(null,"Fullscreen Mode must be enabled in Settings.");setTimeout(function(){chrome.app.window.current().restore()},1e3);return}}chrome.app.window.current().onFullscreened.addListener(e);chrome.app.window.current().onMaximized.addListener(e)})()}sharedGlobals.showSettings=function(){var t=$("#new-display-name");t.prop("value",e.friendlyName);t.prop("placeholder",device.name);$("#web-video-stream").text("http://127.0.0.1:"+window.httpPort+"/device/"+(device.id||device.serialno)+"/video.flv");$("#settings-modal").modal()}})();
