!function(e,t){function n(e){return o(e.length)+e}function o(e){for(var t=e.toString(16);t.length<4;)t="0"+t;return t}function i(e){return unescape(encodeURIComponent(e))}function r(e){return decodeURIComponent(escape(e))}function s(e){return"ArrayBuffer"==e.constructor.name&&(e=new Uint8Array(e)),r(String.fromCharCode.apply(null,e))}function c(e,t,n){e=i(e);var o=e.length;n&&o++,t||(t=new ArrayBuffer(o));var r=new Uint8Array(t);n&&(r[e.length]=0);for(var s=0,c=e.length;s<c;s++)r[s]=e.charCodeAt(s);return t}function a(e,t,n){"Object"==t.constructor.name&&(t=JSON.stringify(t)),u(e,t+"\n",n)}function d(e,t){function n(){e.read(function(i){for(var r=0;r<i.byteLength;r++)if(i[r]==E){var c=i.subarray(0,r);o.push(c);var a="";for(var d in o)d=o[d],a+=s(d);var l=i.subarray(r+1);return e.unshift(l),void t(a)}o.push(i),n()})}var o=[];n()}function l(e,t){function n(t){o+=s(t),e.read(n)}var o="";e.onClose=function(){t(o)},e.read(n)}function u(e,t,n){"Object"==t.constructor.name&&(t=JSON.stringify(t)),e.write(c(t),n)}function h(e,t){t||(t=window.location);for(var n=t.search.substring(1),o=n.split("&"),i=0;i<o.length;i++){var r=o[i].split("=");if(decodeURIComponent(r[0])==e)return decodeURIComponent(r[1])}}function f(e,t,n,o){return e||(e={items:[]}),e.items.push(t),e.timeout||(e.timeout=setTimeout(function(){delete e.timeout,o(e.items),e.items=[]},n)),e}function p(e){var t=document.createElement("textarea");t.style.position="fixed",t.style.top=0,t.style.left=0,t.style.width="2em",t.style.height="2em",t.style.padding=0,t.style.border="none",t.style.outline="none",t.style.boxShadow="none",t.style.background="transparent",t.value=e,document.body.appendChild(t),t.select();try{document.execCommand("copy")}catch(e){console.log("Oops, unable to copy")}document.body.removeChild(t)}function y(e,t){if(console.log("notification:",e),window.chrome&&window.chrome.notifications){var n=chrome.runtime.getManifest(),o=n.name;t=t||n.icons[128],chrome.notifications.create({type:"basic",iconUrl:t,title:o,message:e})}}function m(){}function g(e,t){this.promise=fetch(e).then(function(e){this.connected=!0,this.response=e,this.reader=this.response.body.getReader(),this.reader.closed.then(function(){this.onClose&&this.dataReceived(null)}.bind(this)),this.onResume(),t(this)}.bind(this),function(e){t(null,e)})}function v(e){this.internalRead=this.read,this.read=this.readWrapper,this.file=e,this.fileRead=0}function w(){var e={showSoftKeys:!0,pinTitleBar:!0,alwaysOnTop:!1,bitrate:0,resolution:0,decoder:0,displaySettings:x[0],dimDisplay:!1};return e}function b(e){return e?(e.friendlyName&&!e.friendlyName.length&&delete e.friendlyName,e):null}function k(e){window.chrome&&window.chrome.storage?chrome.storage.local.get("device-settings",function(t){e(t["device-settings"]||{})}):e({})}function S(e,t){e||(e="web");var n=w();"inkwire"==e&&(n.pinTitleBar=!1,n.showSoftKeys=!1),k(function(o){t(b(o[e]||n))})}function C(e,t,n){return b(t),window.chrome&&window.chrome.storage&&e&&e.indexOf("127.0.0.1")==-1?void k(function(o){o[e]=t,chrome.storage.local.set({"device-settings":o},n)}):void(n&&n())}function R(){for(var e in x){var t=x[e],n=new Option;$(n).html(t.name),$("#display-settings").append(n)}}function I(e){$("#new-display-name").prop("value",e.friendlyName||null),$("#softkeys-check").prop("checked",!!e.showSoftKeys).change(),$("#pin-title-check").prop("checked",!!e.pinTitleBar).change(),$("#always-on-top-check").prop("checked",!!e.alwaysOnTop).change(),$("#bitrate").prop("selectedIndex",e.bitrate||0),$("#decoder").prop("selectedIndex",e.decoder||0),$("#resolution").prop("selectedIndex",e.resolution||0);var t=e.displaySettings&&e.displaySettings.name,n=0;for(var o in x){var i=x[o];if(i.name==t){n=o;break}}$("#display-settings").prop("selectedIndex",n),$("#dim-display").prop("checked",!!e.dimDisplay)}function D(e){var t=$("#notificationModal"),n=t.find("#modal-ok"),o=t.find("#modal-cancel");n.unbind("click"),o.unbind("click"),t.unbind("hidden.bs.modal"),e.cancelButton=e.cancelButton||"Cancel",e.okButton=e.okButton||"OK",e.title=e.title||chrome.runtime.getManifest().name,e.body=e.body||"",e.hideCancel?o.hide():o.show(),n.text(e.okButton),o.text(e.cancelButton),t.find("#modal-title").text(e.title),t.find("#modal-body").html(e.body);var i;n.click(function(){i=!0,e.ok&&e.ok()||$("#notificationModal").modal("hide")}),e.cancel&&(t.on("hidden.bs.modal",function(){i||e.cancel()}),o.click(e.cancel)),$("#notificationModal").modal(),e.duration&&setTimeout(function(){$("#notificationModal").modal("hide")},e.duration)}function A(e,t){D({title:e,body:t,duration:8e3,hideCancel:!0})}var E="\n".charCodeAt(0);(new Date).getTime();String.prototype.startsWith||Object.defineProperty(String.prototype,"startsWith",{enumerable:!1,configurable:!1,writable:!1,value:function(e,t){return t=t||0,this.lastIndexOf(e,t)===t}}),Object.fromArray=function(e){var t={};for(var n in e){var o=e[n];t[o]=o}return t},$.ajaxTransport("+binary",function(e,t,n){if(window.FormData&&(e.dataType&&"binary"==e.dataType||e.data&&(window.ArrayBuffer&&e.data instanceof ArrayBuffer||window.Blob&&e.data instanceof Blob)))return{send:function(t,n){var o=new XMLHttpRequest,i=e.url,r=e.type,s=e.async||!0,c=e.responseType||"blob",a=e.data||null,d=e.username||null,l=e.password||null;o.addEventListener("load",function(){var t={};t[e.dataType]=o.response,n(o.status,o.statusText,t,o.getAllResponseHeaders())}),o.open(r,i,s,d,l);for(var u in t)o.setRequestHeader(u,t[u]);o.responseType=c,o.send(a)},abort:function(){n.abort()}}});(function(){var e={};return function(t,n){if(e[t])return void n(e[t]);var o=new XMLHttpRequest;o.open("GET",t,!0),o.responseType="blob",o.onload=function(o){n(e[t]=window.URL.createObjectURL(this.response))},o.send()}})();!function(){function*e(){}var t=e();t.constructor.prototype.async=function(){function e(){i=o.throw(new Error(arguments)),n()}function t(){var e=arguments[0];i=o.next(e),n()}function n(n){var r,s;if(!i.done){if(!i.value)return void(i=o.next(t));if(i.value.constructor==Promise)return void i.value.then(t).catch(e);if(i.value==Error)r=!0,i=o.next(e);else{if(i.value!=m)throw new Error("Unexpected yield value for callback. Only Error and Success allowed.");s=!0,i=o.next(t)}if(!i.value)throw new Error("Double yield callbacks must explicitly define both Error and Success");if(i.value==Error&&r)throw new Error("Error callback already defined");if(i.value==m&&s)throw new Error("Success callback already defined");if(i.value!=Error&&i.value!=m)throw new Error("Unexpected yield value for callback. Only Error and Success allowed.");i=r?o.next(t):o.next(e)}}var o=this,i=o.next();i.done||n()}}(),window.isElectron=function(){return navigator.userAgent.indexOf("Electron")!=-1},isElectron()||(window.sharedGlobals=window),function(){function e(e){try{for(var t in e)e[t]&&e[t].constructor!=String&&(e[t]=JSON.stringify(e[t]));i+=e.join(" ")+"\n"}catch(e){}}function t(e){return new Promise(function(t,n){return e.getConsoleLog?void e.getConsoleLog(function(e){t({content:e&&e.length?e:"log is empty"})}):void t("getConsoleLog not found")})}var n=console.log,o=console.error,i="";console.error=function(){o.apply(console,arguments),e(Array.prototype.slice.call(arguments))},console.log=function(){n.apply(console,arguments),e(Array.prototype.slice.call(arguments))},sharedGlobals.getConsoleLog=function(e){e(i)},window.gistConsoleLog=function(e,n){chrome.runtime.getBackgroundPage(function(o){t(o).then(function(n){e["background.txt"]=n;var o=chrome.app.window.getAll(),i=o.map(function(n){return t(n.contentWindow).then(function(t){e["window-"+n.id+".txt"]=t})});return Promise.all(i)}).then(function(){var t={description:chrome.runtime.getManifest().name+" console log",public:!1,files:e};fetch("https://vysor.io/gist",{method:"POST",body:JSON.stringify(t)}).then(function(e){e.json().then(function(e){n(e.html_url)})})})})}}(),function(){function e(e){this.buffer=new ArrayBuffer(e),this.dataView=new DataView(this.buffer),this.uint8array=new Uint8Array(this.buffer),this.littleEndian=!1,this.position=0,this.limit=e,this.capacity=e}function t(t,n){var o=8*n,i=t+o,r="get"+i,s="set"+i,c="put"+i;e.prototype[r]=function(){if(this.position+n>this.limit)throw new Error("Not enough room in byte buffer");var e=this.dataView[r](this.position,this.littleEndian);return this.position+=n,e},e.prototype[c]=function(e){if(this.position+n>this.limit)throw new Error("Not enough room in byte buffer");if(null==e||void 0==e||NaN==e||e.constructor!=Number)throw new Error("no value provided");return this.dataView[s](this.position,e,this.littleEndian),this.position+=n,this}}e.prototype.flip=function(){this.limit=this.position,this.position=0},e.prototype.asUint8Array=function(){return this.uint8array.subarray(this.position,this.limit)};var n={Int:[1,2,4],Uint:[1,2,4],Float:[4,8]};for(var o in n){var i=n[o];for(var r in i){var r=i[r];t(o,r)}}e.prototype.put=function(e){if(e.constructor==Number)return this.putInt8(e);if(e.constructor==String&&(e=c(e)),e.constructor==ArrayBuffer&&(e=new Uint8Array(e)),this.position+e.byteLength>this.limit)throw new Error("Not enough room in byte buffer");return this.uint8array.set(e,this.position),this.position+=e.byteLength,this},e.prototype.putByte=e.prototype.putInt8,e.prototype.putShort=e.prototype.putInt16,e.prototype.putInt=e.prototype.putInt32,e.prototype.putFloat=e.prototype.putFloat32,e.prototype.putDouble=e.prototype.putFloat64,window.ByteBuffer=e}(),window.chrome&&window.chrome.sockets&&(chrome.sockets.tcp.onReceive.addListener(function(e){var t=Socket.readers[e.socketId];null!=t&&t.dataReceived(new Uint8Array(e.data))}),chrome.sockets.tcp.onReceiveError.addListener(function(e){var t=Socket.readers[e.socketId];null!=t&&(t.destroy(),t.dataReceived(null))}),chrome.sockets.tcpServer.onAccept.addListener(function(e){chrome.sockets.tcp.setPaused(e.clientSocketId,!1);var t=Server.listeners[e.socketId];null!=t&&t(new Socket({socketId:e.clientSocketId}))})),function(){function e(t,n){if(t.socketId)this.socketId=t.socketId,e.readers[this.socketId]=this;else if(window.chrome&&window.chrome.sockets)chrome.sockets.tcp.create(function(o){this.socketId=o.socketId,chrome.sockets.tcp.connect(this.socketId,t.host,t.port,function(t){t?(chrome.runtime.lastError,this.destroy(),n(null)):(e.readers[o.socketId]=this,n(this))}.bind(this))}.bind(this));else{var o;t.ns?(this.ns=t.ns,o=!0):(this.ns=new require("net").Socket(),this.ns.connect({port:t.port,host:t.host},function(){o=!0,n(this)}.bind(this))),this.ns.on("close",function(){this.destroy(),o||n(null)}.bind(this)),this.ns.on("data",function(e){this.dataReceived(e)}.bind(this))}}function t(){}e.readers={},e.connect=function(t,n){return new e(t,n)},e.pump=function(e,t,n){if(!e||!t)return console.error("Socket.pump called with null socket",e,t),void n();var o=function(){e.read(i)}.bind(e),i=function(e){var n=e.buffer;(e.byteOffset||e.length!=n.byteLength)&&(n=n.slice(e.byteOffset,e.byteOffset+e.length)),t.write(n,o)}.bind(t);e.read(i),e.onClose=n},e.stream=function(t,n,o){e.pump(t,n,function(){if(n&&n.destroy(),o){var e=o;o=null,e()}}),e.pump(n,t,function(){if(t&&t.destroy(),o){var e=o;o=null,e()}})},e.eat=function(e){function t(){e.read(t)}t()},e.prototype.read=function(){if(this.pendingCallback)throw new Error("double callback");if(this.closed&&!this.pending){var e=this.onClose;return void(e&&(delete this.onClose,e()))}var t=0;"Number"==arguments[t].constructor.name?this.pendingLength=arguments[t++]:this.pendingLength=0;var e=arguments[t];if(!this.pending||this.paused)return void(this.pendingCallback=e);if(this.pendingLength){if(this.pendingLength>this.buffered())return void(this.pendingCallback=e)}else this.pendingLength=this.buffered();for(var n,o=0;o<this.pendingLength;){var i=this.pending.shift();this.bufferedLength-=i.length,this.pending.length||delete this.pending;var r=i,s=Math.min(r.byteLength,this.pendingLength-o);if(s!=r.byteLength){var c=r.subarray(0,s),a=r.subarray(s);this.unshift(a),r=c}n||r.byteLength==this.pendingLength||(n=new Uint8Array(this.pendingLength)),n?n.set(r,o):n=r,o+=r.byteLength}e(n)},e.prototype.write=function(e,t){if(this.pendingWrite&&console.error("write is already in progress!"),null==t&&(console.error("write callback is null?"),t=function(){}),this.pendingWrite=t,window.chrome&&window.chrome.sockets)chrome.sockets.tcp.send(this.socketId,e,function(n){return chrome.runtime.lastError,!n||n.resultCode?void delete this.pendingWrite:void(n.bytesSent<e.byteLength?this.write(e.slice(n.bytesSent),t):(delete this.pendingWrite,t()))}.bind(this));else{if(!this.ns)return;if(!e.byteLength)return void require("process").nextTick(function(){delete this.pendingWrite,t()}.bind(this));const n=window.Buffer||require("buffer").Buffer;this.ns.write(n.from(e),function(){delete this.pendingWrite,t()}.bind(this))}},e.prototype.destroy=function(e,t){window.chrome&&window.chrome.sockets?chrome.sockets.tcp.close(this.socketId,function(){chrome.runtime.lastError}):(this.dataReceived(null),this.ns&&(this.ns.destroy(),delete this.ns))},e.prototype.unshift=function(e){0!=e.byteLength&&(this.pending?this.pending.unshift(e):this.pending=[e],this.bufferedLength||(this.bufferedLength=0),this.bufferedLength+=e.length)},e.prototype.dataReceived=function(e){if(e&&(e.asUint8Array&&(e=e.asUint8Array()),e.constructor==ArrayBuffer&&(e=new Uint8Array(e))),e&&e.length){var t=new Uint8Array(e);this.pending?this.pending.push(t):this.pending=[t]}if(null==e?this.closed=!0:(this.bufferedLength||(this.bufferedLength=0),this.bufferedLength+=e.length),this.paused||!this.pending||!this.pending.length){var n=this.onClose;return void(this.closed&&n&&(delete this.onClose,n()))}var o=this.pendingLength,n=this.pendingCallback;n&&(delete this.pendingCallback,this.read(o,n))},e.prototype.buffered=function(){return this.bufferedLength},e.prototype.pause=function(){this.paused||(this.paused=!0,this.onPause())},e.prototype.resume=function(){this.paused&&(this.paused=!1,this.onResume())},e.prototype.onResume=function(){chrome.sockets.tcp.setPaused(this.socketId,!1,function(){})},e.prototype.onPause=function(){chrome.sockets.tcp.setPaused(this.socketId,!0,function(){})},t.listeners={},t.prototype.__proto__=e.prototype,t.prototype.destroy=function(){window.chrome&&window.chrome.sockets?chrome.sockets.tcpServer.close(this.socketId,function(){chrome.runtime.lastError}):this.ns&&(this.ns.close(),delete this.ns)},t.prototype.listen=function(n,o,i){var r,s;"Number"==n.constructor.name?(r=n,s="0.0.0.0"):(s=n.address,r=n.port),window.chrome&&window.chrome.sockets?chrome.sockets.tcpServer.create(function(e){this.socketId=e.socketId,t.listeners[this.socketId]=o,chrome.sockets.tcpServer.listen(e.socketId,s,r,function(e){return chrome.runtime.lastError,e?(this.destroy(),void(i&&i(e))):void chrome.sockets.tcpServer.getInfo(this.socketId,function(t){this.localAddress=t.localAddress,this.localPort=t.localPort,i&&i(e)}.bind(this))}.bind(this))}.bind(this)):(this.ns=require("net").createServer(function(t){o(new e({ns:t}))}.bind(this)),this.ns.on("close",function(){this.destroy()}.bind(this)),this.ns.on("error",function(e){i&&i(e)}.bind(this)),this.ns.on("listening",function(){var e=this.ns.address();this.localAddress=e.address,this.localPort=e.port,i&&i()}.bind(this)),this.ns.listen({port:r,host:s}))},window.Socket=e,window.Server=t}(),g.connect=function(e,t){new g(e,t)},g.prototype.write=function(e,t){throw new Error("write not supported on fetch socket")},g.prototype.destroy=function(){this.promise&&this.promise.cancel&&this.promise.cancel()},g.prototype.unshift=Socket.prototype.unshift,g.prototype.dataReceived=Socket.prototype.dataReceived,g.prototype.read=Socket.prototype.read,g.prototype.pause=Socket.prototype.pause,g.prototype.resume=Socket.prototype.resume,g.prototype.buffered=Socket.prototype.buffered,g.prototype.onPause=function(){},g.prototype.onResume=function(){this.reader.read().then(function(e){e.value&&(this.dataReceived(e.value),this.paused||this.onResume())}.bind(this))},function(){function e(e,t){this.conn=e,this.dc=t,this.gotEof=!1,t.onmessage=function(e){var t=new Uint8Array(e.data),n=1==t[t.byteLength-1];this.dataReceived(t.subarray(0,t.byteLength-1)),n&&(this.gotEof=!0,this.destroy())}.bind(this),t.onclose=t.onerror=this.destroy.bind(this),this.needsBufferShim=!0}function t(e,t,n){this.manager=e,this.pc=t,this.key=n,this.pc.oniceconnectionstatechange=function(){"new"!=this.pc.iceConnectionState&&"checking"!=this.pc.iceConnectionState&&delete e.gcmRtcConnections[n],"disconnected"!=this.pc.iceConnectionState&&"closed"!=this.pc.iceConnectionState||this.destroy()}.bind(this)}function n(e,t,n){this.senders=e,this.registrationId=t,this.rtcc=n,this.gcmRtcConnections={},this.gcmRtcListeners={}}e.prototype.buffered=Socket.prototype.buffered,e.prototype.unshift=Socket.prototype.unshift,e.prototype.dataReceived=Socket.prototype.dataReceived,e.prototype.read=Socket.prototype.read,e.prototype.pause=Socket.prototype.pause,e.prototype.resume=Socket.prototype.resume,e.prototype.buffered=Socket.prototype.buffered,e.prototype.writeable=function(){var e=this.writeCallback;e&&(delete this.writeCallback,e())},e.prototype.write=function(e,t){if(!this.dc||"open"!=this.dc.readyState)return void this.destroy();this.writeCallback=t;var n=new Uint8Array(e.byteLength+1);if(n.set(new Uint8Array(e)),this.dc.send(n.buffer),!this.reentrantWrite)try{for(this.reentrantWrite=!0;this.writeCallback&&(0==this.dc.bufferedAmount||this.needsBufferShim);)this.writeable()}finally{this.reentrantWrite=!1}},e.prototype.destroy=function(){if(this.dataReceived(null),null!=this.dc){var e=this.dc;if(this.dc=null,e.onclose=null,e.onerror=null,"open"==e.readyState)try{e.send(new Uint8Array([1])),this.gotEof?this.conn.recycleChannel(e):this.conn.waitForEof(e)}catch(e){}}},t.prototype.waitForCommand=function(t){t.onmessage=function(n){if(1!=n.data.byteLength){this.removeChannel(t);var o=s(n.data),i=new e(this,t);this.openSocket(o,i)}}.bind(this)},t.prototype.compactChannels=function(){this.inboundChannels&&!this.inboundChannels.length&&(this.inboundChannels=null),this.outboundChannels&&!this.outboundChannels.length&&(this.outboundChannels=null)},t.prototype.getAppropriateChannels=function(e,t){var n;return e.inbound?(!this.inboundChannels&&t&&(this.inboundChannels=[]),n=this.inboundChannels):(!this.outboundChannels&&t&&(this.outboundChannels=[]),n=this.outboundChannels),n},t.prototype.removeChannel=function(e){if(channels=this.getAppropriateChannels(e),channels){var t=channels.indexOf(e);t!=-1&&(channels.splice(t,1),this.compactChannels())}},t.prototype.waitForEof=function(e){e.onmessage=function(t){var n=new Uint8Array(t.data),o=1==n[n.byteLength-1];o&&this.recycleChannel(e)}.bind(this)},t.prototype.recycleChannel=function(e){var t=this.getAppropriateChannels(e,!0);t.push(e),e.onclose=e.onerror=function(){this.removeChannel(e)}.bind(this),this.waitForCommand(e)},t.prototype.addCandidates=function(e){for(var t in e.candidates)this.pc.addIceCandidate(new RTCIceCandidate(e.candidates[t]))},t.prototype.setupPinger=function(e){function t(){e.send(c("ping")),n=setTimeout(t,1e3)}var n;e.onmessage=function(e){},e.onclose=e.onerror=function(){clearTimeout(n),this.destroy()}.bind(this),t()},t.prototype.listenSockets=function(){this.pc.ondatachannel=function(e){e.channel.inbound=!0,this.waitForCommand(e.channel)}.bind(this)},t.prototype.prepareChannel=function(e){var t=this.pc.createDataChannel(e||"gcm",{reliable:!0,ordered:!0});return t.binaryType="arraybuffer",t},t.prototype.newSocket=function(t,n){if("closed"==this.pc.signalingState)return void n();if(this.outboundChannels){var o=this.outboundChannels.shift();this.compactChannels(),o.send(c(t));var i=new e(this,o);return void n(i,this)}var o=this.prepareChannel("gcm");o.onopen=function(){o.send(c(t));var i=new e(this,o);n(i,this)}.bind(this)},t.prototype.destroy=function(){delete this.manager.gcmRtcConnections[this.key],"closed"!=this.pc.signalingState&&this.pc.close();var e=this.onClose;e&&(delete this.onClose,e())},n.prototype.onMessage=function(e){var t=JSON.parse(e.message),o=e.type,i=e.senderId,r=e.src,s=e.srcPort,c=e.dstPort;if("offer"==o){var a=this.gcmRtcListeners[c];return void(a?a.listener.incoming(i,r,s,c,t,a.listenCallback):console.log("not listening on "+c))}if("answer"==o){var d=n.getKey(r,s,c),l=this.gcmRtcConnections[d];return l?void l.manager.incoming(i,r,s,c,t):void console.log("pending connection not found")}n.onUnknownMessage?n.onUnknownMessage(e):console.log("unknown message "+o)},n.hasLoadedChannels=!1,n.start=function(e,t,o){if(console.log("starting GtcRtcManger"),window.chrome&&window.chrome.gcm){var i=Object.keys(e);chrome.gcm.register(i,function(i){if(chrome.runtime.lastError,!i)return void o();var r=new n(e,i,t);chrome.gcm.onMessage.addListener(function(e){r.onMessage(e.data)}),o(r)})}else{var r=new n(e,null,t);$.getScript("https://push.clockworkmod.com/socket.io/socket.io.js",function(){var e=io("https://push.clockworkmod.com");e.on("registration",function(e){e="web:"+e,r.registrationId?(r.registrationId=e,r.onRegistrationIdChanged&&r.onRegistrationIdChanged(e)):(r.registrationId=e,o(r))}),e.on("data",function(e){r.onMessage(e)})})}},n.prototype.ensureChannel=function(){function e(){return delete n.channelPromise,n.gcmRtcConnections={},n.channel&&(delete n.channel,!Object.keys(n.gcmRtcListeners).length)?void console.log("not reconnecting, no listeners"):void t()}function t(){console.error("scheduling gcm reconnect"),n.reconnectTimeout=f(n.reconnectTimeout,null,3e5,function(){console.error("reconnecting gcm"),n.ensureChannel()})}if(this.channel)return Promise.resolve();var n=this;return this.channelPromise?this.channelPromise:this.channelPromise=new Promise(function(o,i){$.ajax({type:"GET",url:"https://vysor-1026.appspot.com/listen",error:function(){delete n.channelPromise,console.error("error ensuring gcm channe",error),t()},success:function(t){var i=new goog.appengine.Channel(t.token),r={onopen:function(){n.channel=i;var e="web:"+t.channel;n.registrationId=e,n.onRegistrationIdChanged&&n.onRegistrationIdChanged(e),o()},onmessage:function(e){n.onMessage(JSON.parse(e.data))},onerror:function(){console.error("gcm onerror",arguments),e()},onclose:function(){console.error("gcm onclose",arguments),e()}};i.open(r)}})})},n.prototype.sendGcm=function(e,t,n,o,i,r){e||(e=this.defaultSenderId),t.startsWith("web:")?$.ajax({type:"POST",url:"https://vysor-1026.appspot.com/send",data:JSON.stringify({channel:t.substring(4),data:{senderId:e,src:this.registrationId,srcPort:o,dstPort:n,type:i,message:JSON.stringify(r)}}),contentType:"application/json",dataType:"json",success:function(){}}):$.ajax({type:"POST",url:"https://gcm-http.googleapis.com/gcm/send",headers:{Authorization:"key="+this.senders[e]},data:JSON.stringify({to:t,data:{senderId:e,src:this.registrationId,srcPort:o,dstPort:n,type:i,message:JSON.stringify(r)}}),contentType:"application/json",dataType:"json",error:function(){console.log("gcm error",arguments)},success:function(){console.log("gcm",arguments)}})},n.getKey=function(e,t,n){return n+":"+t+":"+e},n.prototype.setupPeerConnection=function(e,o,i,r,s,c){var a,d=window.RTCPeerConnection||window.webkitRTCPeerConnection,l=new d(this.rtcc),u=function(t){var n=[];for(var a in t)a=t[a],n.push(a),JSON.stringify(n).length>3200&&(this.sendGcm(o,i,r,s,e,{desc:c(),candidates:n}),n=[]);n.length>0&&this.sendGcm(o,i,r,s,e,{desc:c(),candidates:n})}.bind(this);l.onicecandidate=function(e){null!=e.candidate&&(console.log(e.candidate),a=f(a,e.candidate,500,u))}.bind(this);var h=n.getKey(i,r,s),p=new t(this,l,h);return l.onsignalingstatechange=function(e){"stable"==l.signalingState?this.gcmRtcConnections[h]==p:"closed"==l.signalingState&&p.destroy()}.bind(this),this.gcmRtcConnections[h]=p,p},n.gcmPortCount=0,n.prototype.connect=function(e,t){function o(e){l.createOffer(e).then(function(e){i=e,l.setLocalDescription(e)})}var i,r=e.senderId,s=e.registrationId,c=e.port,a=n.gcmPortCount++,d=this.setupPeerConnection("offer",r,s,c,a,function(){return i}),l=d.pc;if(e.audio)navigator.webkitGetUserMedia({audio:!0,video:!1},function(e){l.addStream(e),l.onaddstream=function(e){console.log("got the remote stream"),t(d,e)},o({offerToReceiveAudio:!0,offerToReceiveVideo:!1,voiceActivityDetection:!1})},function(){console.error("audio fail",arguments),o({offerToReceiveAudio:!0,offerToReceiveVideo:!1,voiceActivityDetection:!1})});else{var u=d.prepareChannel("pinger");u.onopen=function(){console.log("got rtc pinger"),d.setupPinger(u),t(d)},d.listenSockets(),o({})}},n.prototype.isListening=function(e){return null!=this.gcmRtcListeners[e]},n.prototype.stopListen=function(e){delete this.gcmRtcListeners[e]},n.prototype.listen=function(e,t){return this.gcmRtcListeners[e]?void console.log("already listening on gcm port "+e):void(this.gcmRtcListeners[e]={listener:this,listenCallback:t})},n.prototype.incoming=function(e,t,o,i,r,s){var c=n.getKey(t,o,i),a=this.gcmRtcConnections[c];if(a){if(!a.remoteDesc){a.remoteDesc=new RTCSessionDescription(r.desc);var d=a.pc;d.setRemoteDescription(a.remoteDesc)}}else{var l;a=this.setupPeerConnection("answer",e,t,o,i,function(){return l}),a.remoteDesc=new RTCSessionDescription(r.desc);var d=a.pc;d.ondatachannel=function(e){console.log("got rtc pinger"),this.setupPinger(e.channel),s(a),this.listenSockets()}.bind(a),d.setRemoteDescription(a.remoteDesc,function(){d.createAnswer().then(function(e){l=e,d.setLocalDescription(e)},function(){console.error("answer error",arguments)})})}a.addCandidates(r)},window.GcmRtcSocket=e,window.GcmRtcManager=n}(),v.prototype.write=function(e,t){throw new Error("write not supported on file socket")},v.prototype.destroy=function(){},v.prototype.buffered=Socket.prototype.buffered,v.prototype.unshift=Socket.prototype.unshift,v.prototype.dataReceived=Socket.prototype.dataReceived,v.prototype.read=Socket.prototype.read,v.prototype.pause=Socket.prototype.pause,v.prototype.resume=Socket.prototype.resume,v.prototype.buffered=Socket.prototype.buffered,v.prototype.onPause=function(){},v.prototype.onResume=function(){},v.prototype.readWrapper=function(){if(this.internalRead.apply(this,arguments),this.pendingCallback){var e=this.pendingLength;if(e||(e=65536),e=Math.min(this.file.size-this.fileRead,e),0==e)return void this.dataReceived(null);var t=this.file.slice(this.fileRead,this.fileRead+e);this.fileRead+=e;var n=new FileReader;n.addEventListener("loadend",function(e){this.dataReceived(new Uint8Array(n.result))}.bind(this)),n.readAsArrayBuffer(t)}},function(){function e(){}var t={};t.sendHostCommand=function(e,t){Socket.connect({host:"127.0.0.1",port:5037},function(n){if(!n)return void t();var i=e;e=o(e.length)+e,n.read(4,function(e){var o=s(e);return"OKAY"!=o?(console.error("error in response to adb host command",i,o),n.destroy(),void t()):void n.read(4,function(e){var o=s(e);return e=parseInt(o,16),0==e||"OKAY"==o?void t(n,new ArrayBuffer(0)):void n.read(e,function(e){t(n,e)})})}),n.write(c(e),function(){})})},t.devices=function(e){function n(e){var t=e;e=e.replace("\t"," ");var n=e.indexOf(" ");if(n!=-1){var i=e.substring(0,n);e=e.substring(n).trim();for(var r;r!=e;)r=e,e=e.replace("  "," ");var s={},c=e.indexOf(" ");c==-1&&(c=e.length);var a=e.substring(0,c);for(e=e.substring(c+1);e.length&&(n=e.indexOf(":"),n!=-1);){var d,l=e.substring(0,n),u=e.substring(n+1),h=u.indexOf(" "),f=u.indexOf(":");if(h==-1||f==-1)d=u,e="";else for(;h!=-1&&h<f;)d=u.substring(0,h),e=u.substring(h+1),h=u.indexOf(" ",h+1);s[l]=d}var p;p=s.model?s.model.replace("_"," "):i,o[i]={serialno:i,name:p,status:a,properties:t}}}var o={};t.sendHostCommand("host:devices-l",function(t,i){if(!t)return void e();t.destroy(),i=s(i),console.log("ADB devices:",i),i=i.trim();var r=i.split("\n");for(var c in r)c=r[c],n(c);console.log("parsed ADB devices:",o),e(o)})},t.killServer=function(e){t.sendHostCommand("host:kill-server",function(t,n){return t?(t.destroy(),n=s(n),void(e&&e())):void e()})},t.sendClientCommand=function(e,t){var n=e.command,i=e.serialno;Socket.connect({host:"127.0.0.1",port:5037},function(e){if(!e)return void t();e.read(4,function(i){var r=s(i);if("OKAY"!=r)return e.destroy(),void t(null);var a=n;a=o(a.length)+a,e.read(4,function(n){var o=s(n);return"OKAY"!=o?(e.destroy(),void t(null)):void t(e)}),e.write(c(a),function(){})});var r="host:transport:"+i;r=o(r.length)+r,e.write(c(r),function(){})})},t.shell=function(e,n){var o=e.command;e.serialno;t.getOrCreateSockFactory(e).newSocket("shell:"+o,function(e){return e?void l(e,function(e){n(e)}):void n()})},t.forward=function(e,n){var o="host-serial:"+e.serialno+":forward:"+e.from+";"+e.to;t.sendHostCommand(o,function(e,t){e&&e.destroy(),n(e,t)})},e.MKID=function(e,t,n,o){return e.charCodeAt(0)|t.charCodeAt(0)<<8|n.charCodeAt(0)<<16|o.charCodeAt(0)<<24},e.ID_RECV=e.MKID("R","E","C","V"),e.ID_SEND=e.MKID("S","E","N","D"),e.ID_DONE=e.MKID("D","O","N","E"),e.ID_DATA=e.MKID("D","A","T","A"),e.DATA_MAX=65536,t.pull=function(n,o){var i=n.file,r=(n.serialno,n.fileEntry),s=n.socket;s||!function(){var e;s={write:function(t,n){return e?(e.onwriteend=n,void e.write(new Blob([t]))):void r.createWriter(function(o){e=o,s.write(t,n)})}}}();var a=new DummySocket;Socket.pump(a,s,function(){o(r)}),t.getOrCreateSockFactory(n).newSocket("sync:",function(t){function n(e){t.read(e,function(e){a.dataReceived(e),r()})}function r(){t.read(8,function(i){var r=new DataView(i.buffer,i.byteOffset,i.byteLength),s=r.getUint32(0,!0);if(s==e.ID_DATA){var c=r.getUint32(4,!0);return void n(c)}return t.destroy(),s==e.ID_DONE?void a.dataReceived(null):void o()})}if(!t)return void o();var s=new ArrayBuffer(8),d=new DataView(s);d.setUint32(0,e.ID_RECV,!0),d.setUint32(4,i.length,!0),t.write(s,function(){t.write(c(i),function(){r()})})})},t.createSocketFactory=function(e){return{newSocket:function(n,o){t.sendClientCommand({serialno:e,command:n},o)}}},t.getOrCreateSockFactory=function(e){return e.socketFactory||t.createSocketFactory(e.serialno)},t.push=function(n,o){var i=n.file,r=(n.serialno,n.socket);t.getOrCreateSockFactory(n).newSocket("sync:",function(t){if(!t)return void o();var n=new ArrayBuffer(8),s=new DataView(n),a=i+",0644";s.setUint32(0,e.ID_SEND,!0),s.setUint32(4,a.length,!0),t.write(n,function(){t.write(c(a),function(){function n(){r.read(function(t){if(t.byteLength>e.DATA_MAX){var n=t.subarray(e.DATA_MAX);t=t.subarray(0,e.DATA_MAX),r.unshift(n)}i(t)})}function i(o){var i=new ArrayBuffer(8),r=new DataView(i);r.setUint32(0,e.ID_DATA,!0),r.setUint32(4,o.byteLength,!0),t.write(i,function(){var e=o.buffer;(o.byteOffset||o.length!=e.byteLength)&&(e=e.slice(o.byteOffset,o.byteOffset+o.byteLength)),t.write(e,function(){n()})})}r.onClose=function(){var n=new ArrayBuffer(8),i=new DataView(n);i.setUint32(0,e.ID_DONE,!0),i.setUint32(4,0,!0),t.write(n,function(){t.read(8,function(){o()})})},n()})})})},window.Adb=t}();var x=[{name:"Default Settings",size:"reset",density:"reset"},{name:"Resizable (96dpi)",size:"reset",density:"96",freeSize:!0},{name:"Resizable (144dpi)",size:"reset",density:"144",freeSize:!0},{name:"1080p (96dpi)",size:"1920x1080",density:"96"},{name:"4K (144dpi)",size:"3840x2160",density:"144"},{name:"Galaxy Nexus",size:"720x1280",density:"320"},{name:"Nexus 4",size:"768x1280",density:"320"},{name:"Nexus 5",size:"1080x1920",density:"480"},{name:"Nexus 6",size:"1440x2560",density:"560"},{name:"Nexus 6p",size:"1440x2560",density:"560"},{name:"Nexus 7 (2012)",size:"800x1280",density:"213"},{name:"Nexus 7 (2013)",size:"1200x1920",density:"320"},{name:"Nexus 9",size:"1536x2048",density:"320"}];!function(){function e(e,t,n,o){this.socket=e,this.videoOnly=!0;var i=new ByteBuffer(1024);i.put("FLV"),i.put(1),this.videoOnly?i.put(1):i.put(5),i.putInt(9),i.putInt(0),i.flip(),this.socket.dataReceived(i),this.setParameter(t,n,o)}function t(e,t){return e.put(a),e.putDouble(t),e}function n(e,t){var n=c(t);return e.putShort(n.byteLength),e.put(n),e}function o(e,t){return e.putShort(t>>8&65535),e.put(255&t),e}var i=9,r=9,s=18,a=0,d=2,l=8,u=7,h=4,f=1<<h|7,p=2<<h|7;
e.prototype.setParameter=function(e,r,c){var a=new ByteBuffer(1024);a.put(s),this.videoOnly?o(a,182):o(a,290),o(a,0),a.putInt(0);var h=a.position;a.put(d),n(a,"onMetaData"),a.put(l),this.videoOnly?a.putInt(7):a.putInt(12),n(a,"duration"),t(a,0),n(a,"width"),t(a,e),n(a,"height"),t(a,r),n(a,"framerate"),t(a,c),n(a,"videocodecid"),t(a,u),n(a,"videodatarate"),t(a,0),this.videoOnly||(n(a,"audiodatarate"),t(a,62.5),n(a,"audiosamplerate"),t(a,5112),n(a,"audiosamplesize"),t(a,8),n(a,"stereo"),a.put(0),n(a,"audiocodecid"),t(a,0)),n(a,"encoder"),a.put(d),n(a,"Lavf52.87.1"),n(a,"filesize"),t(a,0),n(a,""),a.put(i);var f=a.position,p=f-h;a.putInt(p+11),a.flip(),this.socket.dataReceived(a)},e.prototype.addVideoHeader=function(e){for(var t=4;t<e.length&&(0!=e[t+0]||0!=e[t+1]||0!=e[t+2]||1!=e[t+3]);t++);var n=e.subarray(0,t),i=e.subarray(t),s=new ByteBuffer(1024),c=n.length-4+i.length-4+16;s.put(r),o(s,c),o(s,0),s.put(0),o(s,0),s.put(7|f),s.put(0),o(s,0),s.put(1),s.put(n[5]),s.put(n[6]),s.put(n[7]),s.put(255),s.put(225),s.putShort(n.length-4),s.put(n.subarray(4)),s.put(1),s.putShort(i.length-4),s.put(i.subarray(4)),s.putInt(11+c),s.flip(),this.socket.dataReceived(s)},e.prototype.addVideoFrame=function(e,t,n){var i=new ByteBuffer(1024);i.put(r),o(i,5+e.length),this.firstPresentationTimestampMs||(this.firstPresentationTimestampMs=t);var s=t-this.firstPresentationTimestampMs;o(i,s),i.put(s>>24&255),o(i,0),i.put(n?f:p),i.put(1),o(i,0),i.flip();var c=new ByteBuffer(e.length);c.put(e),c.flip(),c.putInt(e.length-4),c.position=0;var a=new ByteBuffer(1024);a.putInt(16+e.length),a.flip(),this.socket.dataReceived(i),this.socket.dataReceived(c),this.socket.dataReceived(a)},window.FlashPackager=e}();var T,O;!function(){function e(e){O&&(e.clientX&&(e.downDelta=Date.now()-Y,H||(H=$("#listener")),e.clientX=e.clientX/H.width()*N,e.clientX>N||e.clientX<0)||e.clientY&&(H||(H=$("#mirror")),e.clientY=e.clientY/H.height()*U,e.clientY>U||e.clientY<0)||O.send(JSON.stringify(e)))}function t(t,n){if(t){if("String"==t.constructor.name){if(t.startsWith("KEYCODE_"))return e({type:"keyevent",keyevent:t}),!0;switch(t){case"VYSOR_SHOW_TITLE_BAR":o();break;case"VYSOR_RECORD_SCREEN":ee(n);break;case"VYSOR_SCREENSHOT":chrome.browser.openTab({url:"http://127.0.0.1:"+window.httpPort+"/device/"+(device.id||device.serialno)+"/screenshot-"+Date.now()+".jpg"});break;case"VYSOR_OPEN_DEVICE_SETTINGS":showSettings(),openList();break;case"VYSOR_ROTATE_SCREEN":e({type:"rotate"});break;default:return}return!0}return"Number"==t.constructor.name?(e({type:"keycode",keycode:t}),!0):t.keyevent?(e({type:"keyevent",keyevent:t.keyevent,shift:!!(t.shiftKey&&n&&n.shiftKey)}),!0):t.keycode?(e({type:"keycode",keycode:t.keycode,shift:!!(t.shiftKey&&n&&n.shiftKey)}),!0):void 0}}function o(){return"inkwire"==M?void $(".head").hide():J?(clearTimeout(P),void $(".head").fadeTo(0,1)):($(".head").fadeTo(0,.8),clearTimeout(P),void(P=setTimeout(function(){$(".head").fadeOut()},2e3)))}function i(e,t){if(c())V=N,W=U;else if(window.chrome&&window.chrome.app&&window.chrome.app.window&&s()&&(V=screen.availWidth,W=screen.availHeight),t==N&&e==U){var n=V;V=W,W=n}else{var o;o=N>U?Math.max(innerWidth,innerHeight):Math.min(innerWidth,innerHeight);var i=o*(U/N);V=o,W=i}l()}function r(){return!window.chrome||!window.chrome.app||!window.chrome.app.window}function s(){return document.webkitFullscreenElement||document.msFullscreenElement||document.mozFullscreenElement||document.fullscreenElement}function c(){return B&&B.displaySettings&&B.displaySettings.freeSize}function l(){var e=innerWidth,t=innerHeight,n=screen.availWidth,o=screen.availHeight;(s()||c()||r())&&(n=e,o=t),V>n&&(V=n,W=U/N*V);var i=0;if(W+Q+J+i>o&&(W=o-Q-J-i,V=N/U*W),V&&W){var a=Math.round(V),d=Math.round(W+Q+J);s()||c()||(G?G=!1:(G=!0,isElectron()?(Math.abs(innerWidth-a)>=2||Math.abs(innerHeight-d)>=2)&&chrome.app.window.current().w.setContentSize(a,d):window.chrome&&window.chrome.app&&window.chrome.app.window&&(Math.abs(innerWidth-a)>=2&&(chrome.app.window.current().innerBounds.width=a),Math.abs(innerHeight-d)>=2&&(chrome.app.window.current().innerBounds.height=d))));var l=(e-V)/2,u=$("#mirror, #listener");u.css("left",l),u.css("top",(t-W-Q+J)/2),$(".foot").width(V),$(".foot").css("left",l),$(".overlay").width(V),$(".overlay").css("left",l),u=$("#mirror, embed, #listener"),u.width(Math.round(V)),u.height(Math.round(W)),$("#dead, #drag, #reconnect").width(V),$("#dead, #drag, #reconnect").height(W+Q+J)}}function u(e){window.chrome&&window.chrome.storage&&chrome.storage.local.get(["vysorUsage","vysorDailyUsage","lastDailyReport"],function(t){var n=t.vysorUsage,o=t.lastDailyReport,i=t.vysorDailyUsage,r=Date.now();if(n||(n=0),i||(i=0),o){if(r>o+864e5){var s=i/36e5;s=Math.round(2*s)/2,s<=24&&s>=0&&(tracker.sendEvent("daily-usage",s.toString()),tracker.sendEvent("daily-usage-licensed",_lm._il)),i=0,chrome.storage.local.set({lastDailyReport:r})}}else chrome.storage.local.set({lastDailyReport:r});n+=e,i+=e,chrome.storage.local.set({vysorUsage:n,vysorDailyUsage:i})})}function m(){$("#listener").empty();var e,t,n;isElectron()?(e="host",t=null,n="application/x-ppapi-vysor"):(e="pnacl",t="video_decode/pnacl/Release",n=null);var o;common.createNaClModule("video_decode",n,e,t,_,z,{},function(e){"decoder-falling-behind"==e.data?this.onDecoderFallingBehind&&this.onDecoderFallingBehind():"paint-falling-behind"==e.data||"decoder-ready"==e.data&&(this.onReady?this.onReady():console.error("no listener for decoder-ready"))}.bind(this),function(){if(o)return console.error("NACL module has already initalized"),console.error(o),void console.error(new Error("NACL New Initialization Stack"));o=new Error("NACL Initialization Stack"),console.log("NACL module initialized");var e=oe[B.decoder||0];console.log("decoder:",e),common.naclModule.postMessage(e)}.bind(this)),l()}function g(e){e?document.documentElement.requestFullscreen?document.documentElement.requestFullscreen():document.documentElement.webkitRequestFullscreen?document.documentElement.webkitRequestFullscreen():document.documentElement.msRequestFullscreen?document.documentElement.msRequestFullscreen():document.documentElement.mozRequestFullScreen&&document.documentElement.mozRequestFullScreen():document.exitFullscreen?document.exitFullscreen():document.webkitExitFullscreen?document.webkitExitFullscreen():document.mozExitFullscreen?document.mozExitFullscreen():document.mskitExitFullscreen&&document.mskitExitFullscreen()}function b(){$(".topbuttonbar>.btn-toolbar").empty(),$(".head").attr("style",Z.titleBar.style);var e=Z.titleBar.buttonGroups;$(e).each(function(e,n){var o=$("<span></span>");o.attr("class","btn-group btn-group-xs"),o.attr("role","group"),$(n).each(function(e,n){var i=$("<a></a>");i.attr("class","btn btn-default fa "+n.class),i.attr("title",n.title),i.click(function(e){t(n.event,e)}),o.append(i)}),$(".topbuttonbar>.btn-toolbar").append(o)})}function k(){$(".foot-row").empty(),$(".foot-row").attr("style",Z.navigationBar.style);var e=Z.navigationBar.buttons,n=Math.round(100/e.length)+"%";$(e).each(function(e,o){var i=$("<span></span>");i.attr("class","fa fa-lg "+o.class),i.attr("title",o.title),i.width(n),i.click(function(){t(o.event)}),$(".foot-row").append(i)})}function E(){if(window._lm&&(se||!_lm._il)){for(var t=[],n=1;n<=9;n++)t.unshift(n);var o=t.length+1;$(t).each(function(e){setTimeout(function(){$(".title, title").text("Ad in "+e+" seconds.")},1e3*(o-e))}),e({type:"toast",toast:"Vysor ad in "+o+" seconds.\nUpgrade for an ad free experience."}),setTimeout(function(){$(".title, title").text(B.friendlyName||device.name),O||(clearInterval(ce),ce=null),tracker.sendEvent("ad-impression"),e({type:"ad"})},1e3*o)}}function L(){window._lm&&(!se&&_lm._il||ce||(clearInterval(ce),ce=setInterval(E,18e5),E()))}function F(){window._lm&&window._lm._il&&(B.hasRecommendedHighQuality||(B.hasRecommendedHighQuality=!0,C(device.id||device.serialno,B),D({title:"High Quality Video",body:"The video quality can be customized by clicking the Settings icon in the toolbar. Would you like to try the recommended High Quality settings?",okButton:"Use High Quality Settings",ok:function(){$("#high-quality-defaults").click(),C(device.id||device.serialno,B)}.bind(this)})))}var B,M,P,N,U,_,z,V,W,H,Y,j,K,X,q,G,J=36,Q=48,Z=vysorDefaultSettings,ee=function(){};sharedGlobals.siphonFlv=function(t){K&&(K.destroy(),K=null,X=null),K=isElectron()?{dataReceived:function(e){e.asUint8Array&&(e=e.asUint8Array()),e.constructor==ArrayBuffer&&(e=new Uint8Array(e)),t.dataReceived(e)},destroy:function(){t.destroy()}}:t,K&&(X=new FlashPackager(K,_,z,30),q=!0,e({type:"resolution",resolution:resolution}))};var te=[0,.25,.5,.75,1],ne=[5e5,75e4,1e6,15e5,2e6,3e6,4e6,6e6,8e6],oe=["software","hardware","hardware_with_fallback"],ie=function(e,t){return t};window.tracker||(window.tracker={sendEvent:function(){},sendAppView:function(){}}),$(window).focus(function(){o(),e({type:"wakeup"})}),$(window).bind("paste",function(t){var n=t.originalEvent.clipboardData.getData("text");n&&n.length&&e({type:"keychar",keychar:n})}),window.addEventListener("mousewheel",function(t){e({type:"scroll",clientX:t.offsetX,clientY:t.offsetY,deltaX:t.wheelDeltaX/100,deltaY:t.wheelDeltaY/100})},!1),$(window).keypress(function(t){var n=String.fromCharCode(t.keyCode);n.length&&e({type:"keychar",keychar:n})}),$(window).keydown(function(e){t(Z.keydown[e.keyCode]||Z.keydown[e.key],e)&&e.stopPropagation()});var re;$(window).resize(function(t){U&&N&&(clearTimeout(re),re=setTimeout(function(){if(c())e({type:"displaySettings",size:innerWidth+"x"+(innerHeight-J-Q),density:B.displaySettings.density});else{var t=innerWidth,n=t*(U/N);V=t,W=n,l()}},500))}),m.prototype.connectH264=function(e,t){return common.naclModule&&common.naclModule.postMessage?void common.naclModule.postMessage({type:"connectH264",hostCommand:n("host:transport:"+e),clientCommand:n("tcp:53517"),password:t+"\n"}):void console.error("connectH264 called before initialization")},m.prototype.decode=function(e,t,n){return common.naclModule&&common.naclModule.postMessage?void common.naclModule.postMessage({buffer:e.buffer,byteOffset:e.byteOffset,byteLength:e.byteLength,presentationTimeMs:t,syncFrame:n}):void console.error("decode called before initialization")},sharedGlobals.docReady=function(){function n(){C(device.id||device.serialno,B)}function i(){$("#settings-modal").modal("hide");var e=$(c).prop("value");B.friendlyName=e,$(".title, title").text(B.friendlyName||device.name),n();var t=chrome.app.window.get("list");t&&t.contentWindow.updateDeviceName&&t.contentWindow.updateDeviceName(device.id||device.serialno,B.friendlyName||device.name)}function r(t,n){$("#bitrate").prop("selectedIndex",t),$("#resolution").prop("selectedIndex",n),B.bitrate=t;var t=ne[t];e({type:"bitrate",bitrate:t}),B.resolution=n;var n=te[n];e({type:"resolution",resolution:n})}ie=window._lm?function(e,t,n){return function(){return j&&!_lm._il?(D({title:"Vysor Pro",body:"The "+e+" feature is only available to Vysor Pro users.",okButton:"Upgrade",ok:function(){_lm.startPurchase()}}),void(n&&n.apply(this,arguments))):void t.apply(this,arguments)}}:function(e,t){return t},ee=ie("Record Screen",function(t){e($(t.target).hasClass("fa-stop-circle-o")?{type:"stop-recording"}:{type:"start-recording"}),$(t.target).toggleClass("fa-video-camera fa-stop-circle-o")});var s;$(document).on("dragover",function(e){$("#drag").fadeIn(),clearTimeout(s),e.preventDefault(),e.stopPropagation()}),$(document).on("dragleave",function(){s=setTimeout(function(){$("#drag").fadeOut()},1e3)}),$(document).on("drop",ie("Drag and Drop",function(e){if($("#drag").fadeOut(),e.preventDefault(),1!=e.originalEvent.dataTransfer.files.length)return void y("You may only drag and drop one file at a time.");var t=e.originalEvent.dataTransfer.files[0];console.log(t),Adb.push({socketFactory:adbSocketFactory,socket:new v(t),file:"/sdcard/vysor/"+t.name,serialno:device.serialno},function(){var e="am start -a android.intent.action.VIEW -d file:/sdcard/vysor/"+t.name;if(t.type&&t.type.length)e+=" -t "+t.type;else if(t.name.endsWith(".apk"))return void Adb.shell({socketFactory:adbSocketFactory,command:"pm install -r /sdcard/vysor/"+t.name,serialno:device.serialno},function(e){y("APK installation result: "+e.trim())});Adb.shell({socketFactory:adbSocketFactory,command:e,serialno:device.serialno},function(){y("File has been transfered and is being opened on the Android.")})})},function(e){$("#drag").fadeOut(),e.preventDefault()})),common.attachDefaultListeners(),$("#listener").mouseup(function(t){0==t.button&&e({type:t.type,clientX:t.offsetX,clientY:t.offsetY})}),$("#listener").bind("touchstart touchend touchmove",function(e){var t;t="touchstart"==e.type?"mousedown":"touchend"==e.type?"mouseup":"mousemove";var n=e.currentTarget;e.stopPropagation(),e.preventDefault(),e=e.originalEvent;var o=e.touches[0];o||(o=e.changedTouches[0]);var i=document.createEvent("MouseEvent");i.initMouseEvent(t,!0,!0,window,e.detail,o.screenX,o.screenY,o.clientX,o.clientY,!1,!1,!1,!1,0,null),i.isTouch=!0,n.dispatchEvent(i)}),console.log("docReady"),$("#listener").mousedown(function(n){return 0==n.button?(Y=Date.now(),void e({type:n.type,clientX:n.offsetX,clientY:n.offsetY})):void t(Z.mousedown[n.button],n)}),$("#listener").mousemove(function(t){(0!=(1&t.buttons)||t.originalEvent.isTouch)&&e({type:t.type,clientX:t.offsetX,clientY:t.offsetY})}),$(".head").bind("mouseup mousedown mousemove",function(e){e.stopPropagation(),o()}),$("#rotate-button").click(function(){e({type:"rotate"})}),$("#screenshot-button").click(function(){chrome.browser.openTab({url:"http://127.0.0.1:"+httpPort+"/device/"+(device.id||device.serialno)+"/screenshot-"+Date.now()+".jpg"})}),$("#record-button").click(ie("Record Screen",function(){e($("#record-button>span").hasClass("fa-video-camera")?{type:"start-recording"}:{type:"stop-recording"}),$("#record-button>span").toggleClass("fa-video-camera fa-stop-circle-o")})),window.chrome&&window.chrome.app&&window.chrome.app.window||($("#screenshot-button").hide(),$("#record-button").hide()),$("#power").click(function(){e({type:"keycode",keycode:26})}),$("#volume-down").click(function(){e({type:"keycode",keycode:25})}),$("#volume-up").click(function(){e({type:"keycode",keycode:24})}),k(),b(),$("#reconnect-button").click(function(){tryReconnect(),$("#reconnect").hide()}),$("#settings-button").click(function(){showSettings(),openList()}),$("#web-video-stream").click(ie("Web Video Stream",function(){var e=$("#web-video-stream").text();$("#settings-modal").modal("hide"),p(e),setTimeout(function(){A("Copied Web Video Stream Link",e)},500)}));var c=$("#new-display-name");$(c).bind("keypress",function(e){e.stopPropagation();var t=e.which;if(13==t)return i(),!1}),$("#settings-ok").click(i),$("#settings-defaults").click(function(){B=w();try{j=!1,I(B)}finally{j=!0}e({type:"displaySettings",size:"reset",density:"reset",resolution:te[B.resolution]})}),$("#softkeys-check").change(function(){B.showSoftKeys=this.checked,this.checked?($(".foot").show(),Q=48):($(".foot").hide(),Q=0),l()}),$("#pin-title-check").change(function(){B.pinTitleBar=this.checked,J=this.checked?36:0,l(),o()}),$("#fullscreen-check").change(ie("Fullscreen Mode",function(){g(this.checked)},function(){this.checked=!1})),$("#always-on-top-check").change(ie("Always On Top",function(){B.alwaysOnTop=this.checked,window.chrome&&window.chrome.app&&window.chrome.app.window&&chrome.app.window.current().setAlwaysOnTop(this.checked)},function(){this.checked=!1})),$("#bitrate").change(ie("Video Quality",function(){B.bitrate=this.selectedIndex;var t=ne[this.selectedIndex];e({type:"bitrate",bitrate:t})},function(){this.selectedIndex=0})),$("#resolution").change(ie("Video Resolution",function(){B.resolution=this.selectedIndex;var t=te[this.selectedIndex];e({type:"resolution",resolution:t})},function(){this.selectedIndex=0})),$("#decoder").change(ie("Video Decoder",function(){B.decoder=this.selectedIndex,e({type:"resolution",resolution:te[B.resolution]})},function(){this.selectedIndex=0})),$("#low-quality-defaults").click(ie("Video Quality",function(){r(0,0)})),$("#medium-quality-defaults").click(ie("Video Quality",function(){r(4,2)})),$("#high-quality-defaults").click(ie("Video Quality",function(){r(8,3)})),$("#display-settings").change(ie("Display Settings",function(){var t=function(){var t=x[this.selectedIndex],o=t.freeSize?innerWidth+"x"+(innerHeight-J-Q):t.size;B.displaySettings=t,n(),e({type:"displaySettings",size:o,density:t.density}),this.selectedIndex&&D({title:"Display Settings",body:"Please close the Vysor window before disconnecting your Android to reset your Display Settings.",hideCancel:!0})}.bind(this);return 0==this.selectedIndex?void t():void D({title:"Display Settings",body:"The Display Settings feature is not recommended for non-Nexus devices and may require you to hard reset your device.",okButton:"Continue",ok:function(){$("#notificationModal").one("hidden.bs.modal",t)}.bind(this),cancel:function(){this.selectedIndex=0}.bind(this)})},function(){this.selectedIndex=0})),$("#dim-display").change(ie("Dim Dislay",function(){B.dimDisplay=this.checked,n(),e({type:"dimDisplay",dimDisplay:this.checked})},function(){this.checked=!1})),R(),l(),o(),window.tracker&&tracker.sendAppView("screen")};var se,ce;sharedGlobals.connectionReady=function(){function t(e){if("displaySize"==e.type){var t=N,n=U;N=e.screenWidth,U=e.screenHeight,i(t,n)}else if("encodeSize"==e.type){if(_=e.encodeWidth,z=e.encodeHeight,!T)return void h();g=f(g,null,1e3,function(){T.onClose=null,T.destroy(),T=null,h()})}else if("clip"==e.type)p(e.clip);else if("password"==e.type);else if("recording"==e.type){var o=e.recording.replace("/sdcard/vysor/","");chrome.browser.openTab({url:"http://127.0.0.1:"+httpPort+"/device/"+(device.id||device.serialno)+"/sdcard-vysor/"+o})}else console.log("unknown",e)}function n(){console.log("input websocket failed, retrying. attempt "+v+" out of "+w),setTimeout(r,500)}function r(){return v++,v==w?void c():void C(function(o){return o?(O=o,T&&(T.onClose=null,T.destroy(),T=null),O.onopen=function(){console.log("input websocket opened"),O.onerror=null;var t=B.displaySettings||{},n=t.freeSize?innerWidth+"x"+(innerHeight-Q-J):"reset"==t.size?null:t.size,o="reset"==t.density?null:t.density;e({type:"password",password:password,resolution:te[B.resolution],size:n,density:o,dimDisplay:B.dimDisplay})},O.onerror=n,void(O.onmessage=function(e){console.log("event from phone",e.data);var n=JSON.parse(e.data);t(n)})):void n()})}function s(){window.tryReconnect?$("#reconnect").fadeIn():$("#dead").fadeIn(),$("#listener").empty()}function c(t){function n(){console.log("starting read loop");var n=setTimeout(function(){y("Your Android screen is unavailable right now. This can sometimes be resolved by rebooting your Android.")},5e3);L(),t.read(4,function(t){clearTimeout(n),F(),l(t),window.chrome&&window.chrome.storage&&e({type:"bitrate",bitrate:ne[B.bitrate]})})}function o(){r=f(r,null,1e3,function(){console.log("requesting sync frame"),e({type:"sync-frame"})})}if(console.log("received socket",t),T&&(T.onClose=null,T.destroy(),T=null),T=t,$(".overlay").fadeOut(),!t)return void s();t.name="h264",t.onClose=function(){try{s()}catch(e){console.log("eating error that occurs with jquery if window is being closed...")}console.log("closing input "),O&&O.close(),O=null,T==t&&(T=null)};var i,r,c=new m,a=!0,d=function(e){var n=e.subarray(8),o=new DataView(e.buffer,e.byteOffset,8),r=o.getUint32(0,!0),s=0!=o.getUint32(4,!0);X&&t==T&&(a?X.addVideoHeader(n):q||X.addVideoFrame(n,r,s)),a&&(q=!1,a=!1),c.decode(n,r,s);var d=Date.now();if(i){var l=d-i;l>6e4&&(i=d,u(l))}else i=d,tracker.sendEvent("view-device");h()},l=function(e){if(4!=e.byteLength)throw new Error("WTF");var n=new DataView(e.buffer,e.byteOffset,4),o=n.getInt32(0,!0);t.read(o,d)},h=function(){t.read(4,l)};c.onDecoderFallingBehind=o,c.onReady=n}function h(){adbSocketFactory.newSocket("tcp:53517",function(e){return e?void a(e,password,function(){c(e)}):void c()})}console.log("connectionReady"),$("#loading").fadeIn(),$("#dead, #reconnect").fadeOut(),o(),device||console.error("device not defined on window object?"),window.chrome&&window.chrome.storage&&window.chrome.storage.local&&chrome.storage.local.get("vysorSettings",function(e){Z={},Object.assign(Z,vysorDefaultSettings,e.vysorSettings);var t=Z.devices&&Z.devices[device.id||device.serialno]||{};Z.navigationBar=t.navigationBar||Z.navigationBar,Z.titleBar=t.titleBar||Z.titleBar,Object.assign(Z.keydown,t.keydown),Object.assign(Z.mousedown,t.mousedown),k(),b()});var g,v=0,w=20;window.adbSocketFactory||("adb-client"==adbSocketFactoryFactory.type?adbSocketFactory=Adb.createSocketFactory(adbSocketFactoryFactory.arguments.serialno):console.error("unknown adb socket factory factory",adbSocketFactoryFactory.type));var C=function(e){adbSocketFactory.newSocket("tcp:53518",function(t){function n(e){r||(r=!0,t.onopen&&t.onopen()),t.onmessage&&t.onmessage({data:e}),d(t,n)}if(!t)return void e();var o,i=function(){if(o){var e;o.length?e=o.shift():o=null,e&&a(t,e,i)}};t.close=t.destroy.bind(t),t.send=function(e){return o?void o.push(e):(o=[],void a(t,e,i))}.bind(t),e(t);var r=!1;t.onClose=function(){r||t.onerror&&t.onerror()},d(t,n)})};console.log("init"),S(device.id||device.serialno,function(e){B=e,r(),window._lm&&window._lm._il||(B.bitrate=0,B.resolution=0,B.alwaysOnTop=!1),I(B),j=!0,l(),$(".title, title").text(B.friendlyName||device.name)})},window.chrome&&window.chrome.app&&window.chrome.app.window?($(document).ready(docReady),function(){function e(){if(!s())return showSettings(),A(null,"Fullscreen Mode must be enabled in Settings."),void setTimeout(function(){chrome.app.window.current().restore()},1e3)}chrome.app.window.current().onFullscreened.addListener(e),chrome.app.window.current().onMaximized.addListener(e)}()):(device={id:"web",serialno:"web"},M=h("mode"),"inkwire"==M&&(device={id:"inkwire",serialno:"inkwire"}),$(document).ready(function(){docReady(),"inkwire"==M&&($("title").text("Inkwire"),J=0,$(".foot").hide(),Q=0,l());var e=h("registrationId");if(e){var t=h("senderId");t||(t="64148182473");var n=h("audio");"inkwire"==M&&(t="3505780036",n=!0);var o;GcmRtcManager.start({3505780036:"AIzaSyDt0GimPRhk8_d_4XjOYzQUn50UkvXhMtE",64148182473:"AIzaSyDd7k1v017osyYbIC92fyf-36s3pv0z73U"},{iceServers:[{url:"turn:n0.clockworkmod.com",username:"foo",credential:"bar"},{url:"turn:n1.clockworkmod.com",username:"foo",credential:"bar"}]},function(i){console.log("attempting to connect to vysor from web"),o=i,o.sharedDevices={};var r=h("channel");o.connect({senderId:t,registrationId:e,port:r},function(o){console.log("web connection established"),n&&(console.log("attempting audio"),i.connect({senderId:t,registrationId:e,port:r,audio:!0},function(e,t){console.log("got audio");var n=new Audio;t.stream.getAudioTracks()[0];n.src=(URL||webkitURL||mozURL).createObjectURL(t.stream),n.play()})),console.log("gcmConn",o),adbSocketFactory=o,console.log("starting remote vysor daemon"),o.newSocket("webstart",function(e){console.log("waiting for password"),d(e,function(t){e.destroy(),console.log("got password",t),window.password=t,connectionReady()})})})})}})),sharedGlobals.updateWindowStatusText=function(e){$("#loading-text").html(e)},sharedGlobals.showSettings=function(){var e=$("#new-display-name");e.prop("value",B.friendlyName),e.prop("placeholder",device.name),$("#web-video-stream").text("http://127.0.0.1:"+window.httpPort+"/device/"+(device.id||device.serialno)+"/video.flv"),$("#settings-modal").modal()}}(),t[""]=e}({},function(){return this}());
